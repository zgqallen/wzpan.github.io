<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Write a Tiny Shell-based Test Framework | HaHack</title>
  <meta name="author" content="Joseph Pan">
  
  <meta name="description" content="介绍如何基于Shell编写一个简单的测试框架。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Write a Tiny Shell-based Test Framework"/>
  <meta property="og:site_name" content="HaHack"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/images/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="HaHack" type="application/atom+xml">
  
  <link rel="stylesheet" href="/dist/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bootstrap-responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/font-awesome.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/style.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/highlight.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/sidenav.min.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/dist/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bubble.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/google-fonts.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/nprogress.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/comment.min.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <!--[if lte IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

<!--  -->
<!--     <link href='https://fonts.googleapis.com/css?family=PT+Sans+Narrow|PT+Sans:400,400italic,700,700italic|Droid+Serif:400,400italic' rel='stylesheet' type='text/css'> -->
<!--     <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'> -->
<!--  -->
  
<script src="/dist/jquery-2.0.3.min.js"></script>


    <script src="/dist/videoGFW.min.js"></script>
	
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-41569408-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;

ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';

var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

	


    <link rel="stylesheet" href="/dist/highlight-default.min.css" media="screen" type="text/css">
    
    <script src="/dist/comment.min.js"></script>
    <script src="/dist/marked.min.js"></script>
    
    <script src="/dist/highlight.min.js"></script>
    <script src="/dist/timeago.min.js"></script>
	<script src="/dist/spin.min.js"></script>


</head>


<body data-spy="scroll" data-target=".toc">  
  <header id="header" class="inner"><div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
            <a data-pjax class="brand" href="/">HaHack</a>
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="nav-collapse collapse">
            <ul class="nav">				
			    
				   <li><a data-pjax href="/archive" title="所有文章归档"><i class="fa fa-archive"></i>Archive</a></li>				   			    			
				   <li><a data-pjax href="/categories" title="所有文章分类"><i class="fa fa-folder"></i>Categories</a></li>				   			    			
				   <li><a data-pjax href="/tags" title="所有文章标签"><i class="fa fa-tags"></i>Tags</a></li>				   			    			
				
				<li class="divider-vertical"></li>
			   	<li><a data-pjax href="/wiki" title="我的笔记库"><i class="fa fa-tasks"></i>wiki</a></li>				   
				
            </ul>			
			<ul class="nav navright">
				<li class="dropdown works">
				<a data-pjax href="#" title="作品集" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-th-large"></i>Works <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://github.com/wzpan/wukong-robot" title="wukong-robot 是一个简单、灵活、优雅的中文语音对话机器人。"><i class="fa fa-github"></i>wukong-robot</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://hahack.com/codes/dingdang-robot-intro/" title="叮当是一款可以工作在 Raspberry Pi 上的中文语音对话机器人/智能音箱项目。"><i class="fa fa-github"></i>dingdang-robot</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://www.hahack.com/codes/comment-js/" title="纯JS实现的静态站点评论系统，使用 Github/OSChina 作为 backend。"><i class="fa fa-github"></i>comment.js</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://hahack.com/codes/eulerian-video-magnification/" title="首个完整的 C++ 开源实现，能同时放大动作变化和颜色变化"><i class="fa fa-github"></i>QtEVM</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/wzpan/wzpan.github.io/wiki/hexo-series" title="为 Hexo 写的一系列主题/工具/插件"><i class="fa fa-github"></i>hexo-series</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/scnu/scnuthesis" title="符合华南师范大学硕士/博士学位论文格式要求的LaTeX模板。"><i class="fa fa-github"></i>SCNUThesis</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/wzpan/wzpan.github.io/wiki/slides" title="一些幻灯片作品"><i class="fa fa-github"></i>Slides</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://hahack.com/codes/fcevm/" title="硕士毕业论文"><i class="fa fa-github"></i>Dissertation</a></li>
				
                	        </ul>
				</li>
				<li class="dropdown">
				<a data-pjax href="#" title="订阅本站" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-rss"></i>Subscribe <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="drop2">
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/atom.xml" title="使用 RSS 阅读器订阅 HaHack"><i class="fa fa-rss-square"></i>RSS</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/wechat.html" title="订阅 HaHack 的公众平台"><i class="fa fa-qrcode"></i>WeChat</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="http://toutiao.io/u/147640" title=""><i class="fa fa-align-justify"></i>Toutiao</a></li>
				
                	        </ul>
				</li>
				
				<li><a data-pjax href="/about" title="关于我"><i class="fa fa-user"></i>About</a></li>				   				
   					  
            </ul>
            </div> <!-- nav-collapse collapse -->
        </div> <!-- container -->
     </div> <!-- navbar-inner -->
</div> <!-- navbar navbar-inverse -->
</header>
  <div class="container" id="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> Write a Tiny Shell-based Test Framework</h1>
		</div>    
	





<div class="row-fluid post">
	<!-- span -->
	
	<div class="span9">
	

	<!-- <div class="alert alert-error">
	<button type="button" class="close" data-dismiss="alert">&times;</button>
	<i class="fa fa-gift"></i> 过年了，<a href="/donate.html" target="_blank">给HaHack派个红包吧</a>！
</div> -->

	
		<div class="alert alert-success">
			<i class="fa fa-info-circle"></i> <p>介绍如何基于Shell编写一个简单的测试框架。</p>

		</div> <!-- alert -->
	
		   

		<!-- content -->
		<div class="mypage">
		<p>参与过服务端的后台开发和测试的同学对服务器压力测试应该都不陌生了。为了对线上服务进行模拟测试，往往需要编写自动化的测试工具。一个常见的原型通常是这样的：</p>
<ol>
<li>从指定地址下载待测的服务器程序，完成本地化配置和部署；</li>
<li>使用事先构造好的压力词表生成一系列的请求，并以指定的速率（QPS）向服务器发送这些请求；</li>
<li>解析服务器的日志，统计压力测试结果。</li>
</ol>
<p>当然，实际上的测试环境可能更加复杂。比如，有些服务还要防止同一个 ip 地址在短时间内发出大量请求，相应的就要通过伪造 ip 等手段覆盖这种 case 。但“万变不离其宗”，基本的流程不会有太大的改动。</p>
<p>无需借助其他语言，以上的工作其实只需用 Linux 自带的 Shell 就可以实现了。这给大多数 Linux 服务器开发测试人员所带来的好处就是完全轻量级，省去了配置开发环境的环节。本文就围绕如何基于 Shell 编写一个简单的测试框架，完成上面的所有工作。<a id="more"></a></p>
<h2 id="待测服务器程序">待测服务器程序</h2>
<p>假定我们有一个名为 myserver 的待测服务器，该服务器程序的打包文件位于 <a href="ftp://whatever.com/myserver-1.0.tar.gz" target="_blank" rel="external">ftp://whatever.com/myserver-1.0.tar.gz</a> 。程序的目录结构如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">\-- myserver-1.0</div><div class="line">  |-- myserver</div><div class="line">  \-- conf</div><div class="line">    |-- server.conf</div><div class="line">  \-- log</div><div class="line">    |-- server.log</div></pre></td></tr></table></figure></p>
<p>其中， myserver 文件是服务器的可执行程序， conf/server.conf 存放着服务器的相关配置，而 log/server.log 则存放服务器在运行过程中的日志。为了简化问题，server.conf 里只有一个配置：</p>
<p><figure class="highlight"><figcaption><span>server.conf</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">port</span>: <span class="string">4000</span></div></pre></td></tr></table></figure></p>
<p>即服务器占用的端口号。</p>
<p>这个服务器程序在执行时，会先读取 server.conf 里头的配置参数，然后在运行过程中处理来自客户端的请求，并生成日志到 server.log 里。</p>
<h2 id="待测程序下载和本地化配置">待测程序下载和本地化配置</h2>
<p>根据上一节的描述，我们已经对待测的服务器程序有了基本的了解。这一节我们可以编写代码实现第一步的工作。</p>
<h3 id="配置文件">配置文件</h3>
<p>首先让我们思考一下我们自己的测试工具可以提供哪些配置参数：</p>
<ul>
<li><strong>PACKAGE_PATH</strong>: 待测程序的下载地址。</li>
<li><strong>WORDS_PATH</strong>: 压力词表的下载地址。</li>
<li><strong>QPS</strong>：每秒钟发送的请求次数。</li>
<li><strong>RESULT_PATH</strong>: 存放压力测试结果的地址。</li>
<li><strong>RESPONSE_PATH</strong>：存放服务器返回的请求结果。</li>
</ul>
<p>当然，还可以把服务器的端口号也作为一个配置项。但后面将使用一个交互式的方案，允许用户在运行测试时再指定端口号。这样的好处是可以动态判断默认的端口号是否被占用了，而让用户指定一个新的端口号。</p>
<p>将这几个配置项写成一个配置文件 tester.conf 中：</p>
<p><figure class="highlight"><figcaption><span>tester.conf</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 被测程序包地址</span></div><div class="line"><span class="variable">PACKAGE_PATH=</span><span class="string">"ftp://whatever.com/myserver-1.0.tar.gz"</span></div><div class="line"><span class="comment"># 压力词表的下载地址</span></div><div class="line"><span class="variable">WORDS_PATH=</span><span class="string">"ftp://whatever.com/myserver-words.txt"</span></div><div class="line"><span class="comment"># 每秒钟发送的请求次数</span></div><div class="line"><span class="variable">QPS=</span><span class="number">800</span></div><div class="line"><span class="comment"># 结果存储地址</span></div><div class="line"><span class="variable">RESULT_PATH=</span><span class="string">"./log/result.log"</span></div><div class="line"><span class="comment"># 服务器返回结果</span></div><div class="line"><span class="variable">RESPONSE_PATH=</span><span class="string">"./log/response.log"</span></div></pre></td></tr></table></figure></p>
<p><div class="alert alert-warning"><i class="fa fa-bell"></i>  <p>注意上面的等号 <code>=</code> 两边不要加空格，因为后面将直接使用 <code>source</code> 命令读入配置。</p>
</div></p>
<h3 id="参数处理">参数处理</h3>
<p>完成后，我们开始编写 tiny_tester.sh：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 如果要记录运行信息</span></div><div class="line"><span class="comment"># set -x</span></div><div class="line"><span class="comment"># 强制管道命令出错退出</span></div><div class="line"><span class="keyword">set</span> -o pipefail</div><div class="line"></div><div class="line">clear</div><div class="line"></div><div class="line">VERSION_NUM=<span class="number">1.0</span>  <span class="comment"># 版本号</span></div><div class="line">PID=$$   <span class="comment"># 本程序的进程PID</span></div><div class="line">CUR_PATH=<span class="variable">$PWD</span>  <span class="comment"># 当前路径</span></div><div class="line">TMP_PATH=/tmp/tiny_tester  <span class="comment"># 临时文件存放路径</span></div><div class="line"></div><div class="line"><span class="comment"># 打印帮助信息</span></div><div class="line">function usage</div><div class="line">{</div><div class="line">    <span class="built_in">echo</span> <span class="string">"OVERVIEW: 一个简易测试框架"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"USAGE: <span class="variable">$0</span> [options]"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"OPTIONS:"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"-c\t\t\t\t\t配置文件的位置，默认为 tester.conf"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"-v\t\t\t\t\t打印版本信息"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"-h\t\t\t\t\t打印帮助信息"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"EXAMPLES:"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span>"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span> -c myconfig.conf"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span> &gt;&amp;<span class="number">2</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"># 解析控制命令行参数</span></div><div class="line">CONFIG_FILE=<span class="string">"<span class="variable">${CUR_PATH}</span>/tester.conf"</span></div><div class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> c:vh OPT</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">case</span> <span class="variable">$OPT</span> <span class="keyword">in</span></div><div class="line">        c|+c)</div><div class="line">            CONFIG_FILE=<span class="variable">${OPTARG}</span></div><div class="line">            ;;</div><div class="line">        v|+v)</div><div class="line">            <span class="built_in">echo</span> <span class="string">"VERSION: <span class="variable">${VERSION_NUM}</span>"</span> &gt;&amp;<span class="number">2</span></div><div class="line">            <span class="keyword">exit</span> <span class="number">0</span></div><div class="line">            ;;</div><div class="line">        h|+h)</div><div class="line">            usage</div><div class="line">            <span class="keyword">exit</span> <span class="number">0</span></div><div class="line">            ;;</div><div class="line">        *)</div><div class="line">            usage</div><div class="line">            <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">            ;;</div><div class="line">    <span class="keyword">esac</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure></p>
<p>上面的程序首先做了一些初始化的工作，然后定义了一个 usage 函数用于打印帮助信息：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">OVERVIEW: 一个简易测试框架</div><div class="line"></div><div class="line">USAGE: tiny_tester.sh [options]</div><div class="line"></div><div class="line">OPTIONS:</div><div class="line">-c			配置文件的位置，默认为 tester.conf</div><div class="line">-v			打印版本信息</div><div class="line">-h			打印帮助信息</div><div class="line"></div><div class="line">EXAMPLES:</div><div class="line">mini_tester.sh</div><div class="line">mini_tester.sh -c myconfig.conf</div></pre></td></tr></table></figure></p>
<h3 id="读取配置文件">读取配置文件</h3>
<p>配置文件的读取比较简单：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">source</span> <span class="variable">${CONFIG_FILE}</span></div></pre></td></tr></table></figure></p>
<p>不过，为了保证程序的鲁棒性，最好在执行这一步前先检查配置文件是否存在：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [ ! <span class="operator">-f</span> <span class="variable">${CONFIG_FILE}</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"ERROR: 文件 <span class="variable">${CONFIG_FILE}</span> 不存在"</span> &gt;&<span class="number">2</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">source</span> <span class="variable">${CONFIG_FILE}</span></div></pre></td></tr></table></figure></p>
<p>在接下来的工作中，肯定少不了诸如文件是否存在、目录是否存在、端口号是否被占用、下载是否成功等判断，为了方便，可以单独编写一个模块 lib/check_helper.sh ，提供一些必要的检查操作和出错处理函数。例如，我们可以先创建一个  <code>check_file</code> 函数，用来检查文件是否存在：</p>
<p><figure class="highlight"><figcaption><span>check_helper.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##! 检查文件是否存在</span></div><div class="line"><span class="comment">##! @TODO:</span></div><div class="line"><span class="comment">##! @AUTHOR: panweizhou</span></div><div class="line"><span class="comment">##! @VERSION: 1.0</span></div><div class="line"><span class="comment">##! @IN: $1 =&gt; file</span></div><div class="line">function <span class="function"><span class="title">check_file</span></span>()</div><div class="line">{</div><div class="line">    file=<span class="variable">$1</span></div><div class="line">    <span class="keyword">if</span> [ ! <span class="operator">-f</span> <span class="variable">${file}</span> ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">""</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"ERROR: 文件 <span class="variable">${file}</span> 不存在"</span> &gt;&amp;<span class="number">2</span></div><div class="line">        <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>于是我们可以把刚刚的配置文件读取改写为：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 读取辅助函数</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">"检查函数库..."</span></div><div class="line"><span class="keyword">if</span> [ ! <span class="operator">-f</span> ./lib/check_helper.sh ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"ERROR：文件 ./lib/check_helper.sh 不存在"</span> &gt;&amp;<span class="number">2</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">source</span> ./lib/check_helper.sh</div><div class="line"></div><div class="line"><span class="comment"># 读取配置文件</span></div><div class="line">check_file <span class="variable">${CONFIG_FILE}</span></div><div class="line"></div><div class="line"><span class="comment"># 读取配置参数</span></div><div class="line"><span class="built_in">source</span> <span class="variable">${CONFIG_FILE}</span></div><div class="line"></div><div class="line"><span class="comment"># 处理两个自定义的存放地址</span></div><div class="line">RESPONSE_PATH_DIR=$(dirname <span class="variable">${RESPONSE_PATH}</span>)</div><div class="line">RESULT_PATH_DIR=$(dirname <span class="variable">${RESULT_PATH}</span>)</div><div class="line"><span class="comment"># 如果所在目录不存在，创建之</span></div><div class="line">create_dir <span class="variable">${RESPONSE_PATH_DIR}</span> || create_dir_err</div><div class="line">create_dir <span class="variable">${RESULT_PATH_DIR}</span> || create_dir_err</div><div class="line"><span class="comment"># 获得两个文件的绝对地址</span></div><div class="line">RESPONSE_PATH=$(abspath <span class="variable">${RESPONSE_PATH}</span>)</div><div class="line">RESULT_PATH=$(abspath <span class="variable">${RESULT_PATH}</span>)</div><div class="line"><span class="comment"># 清空两个文件的内容</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">""</span> &gt; <span class="variable">${RESPONSE_PATH}</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">""</span> &gt; <span class="variable">${RESULT_PATH}</span></div></pre></td></tr></table></figure></p>
<p>这样，主函数中只需先检查并读入一次 check_helper.sh ，以后涉及到文件读入都可以先使用 <code>check_file</code> 函数检查文件是否存在，再读取文件。</p>
<p>注意 create_dir 、create_dir_err、abspath 都是自定义的函数，分别用来检查和创建文件夹、处理创建文件夹错误和获取文件的绝对路径。这几个函数的实现会在下一节介绍。</p>
<h3 id="下载待测程序包">下载待测程序包</h3>
<p>完成配置参数的读取后，我们可以开始编写下载模块，所使用的命令是 <code>wget</code> 。为了方便，我们可以编写另一个模块 lib/utils.sh ，存放实现文件下载等操作的函数。</p>
<p><figure class="highlight"><figcaption><span>utils.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##! 使用 wget 下载文件</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@TODO</span>:</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@AUTHOR</span>: panweizhou</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@VERSION</span>: 1.0</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@IN</span>: $1 =&gt; url</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@OUT</span>: 0 =&gt; success; 1 =&gt; failure</span></div><div class="line">function download()</div><div class="line">{</div><div class="line">    check_arg_num <span class="variable">$#</span> <span class="number">1</span>  <span class="comment"># 检查参数数量</span></div><div class="line">    local url=<span class="variable">$1</span></div><div class="line">    wget -q <span class="variable">$url</span></div><div class="line">    <span class="keyword">return</span> <span class="variable">$?</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">##! 创建文件夹</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@TODO</span>:</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@AUTHOR</span>: panweizhou</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@VERSION</span>: 1.0</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@IN</span>: $1 =&gt; dir</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@OUT</span>: 0 =&gt; success; 1 =&gt; failure</span></div><div class="line">function create_dir()</div><div class="line">{</div><div class="line">    check_arg_num <span class="variable">$#</span> <span class="number">1</span></div><div class="line">    local dir=<span class="variable">$1</span></div><div class="line">    <span class="keyword">if</span> [ ! -d {dir} ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        mkdir -p <span class="variable">${</span>dir} &amp;&amp; <span class="keyword">return</span> <span class="number">0</span> || <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    fi</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">##! 获取文件的绝对路径</span></div><div class="line"><span class="comment">##! TODO: </span></div><div class="line"><span class="comment">##! <span class="yardoctag">@AUTHOR</span>: panweizhou</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@VERSION</span>: 1.0</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@IN</span>: $1 =&gt; path</span></div><div class="line"><span class="comment">##! <span class="yardoctag">@OUT</span>: 0 =&gt; success; 1 =&gt; failure</span></div><div class="line">function abspath()</div><div class="line">{</div><div class="line">    local path=<span class="variable">$1</span></div><div class="line">    local dir=<span class="string">"$(dirname "</span><span class="variable">${</span>path}<span class="string">")"</span></div><div class="line">    <span class="keyword">if</span> [ ! -d <span class="variable">${</span>dir} ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="keyword">return</span> <span class="number">1</span></div><div class="line">    fi</div><div class="line">    cd <span class="variable">${</span>dir}</div><div class="line">    printf <span class="string">"%s/%s\n"</span> <span class="string">"$(pwd)"</span> <span class="string">"$(basename "</span><span class="variable">${</span>path}<span class="string">")"</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>其中，check_arg_num 函数用于检查函数传入参数的数量，可以把它写到 check_helper.sh 中，同时还可以编写 <code>download_err</code> 处理下载失败的情况：</p>
<p><figure class="highlight"><figcaption><span>check_helper.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##! 检查传入参数数量</span></div><div class="line"><span class="comment">##! @TODO:</span></div><div class="line"><span class="comment">##! @AUTHOR: panweizhou</span></div><div class="line"><span class="comment">##! @VERSION: 1.0</span></div><div class="line"><span class="comment">##! @IN: $1 =&gt; real_num</span></div><div class="line"><span class="comment">##! @IN: $2 =&gt; formal_num</span></div><div class="line">function <span class="function"><span class="title">check_arg_num</span></span>()</div><div class="line">{</div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$#</span> <span class="operator">-ne</span> <span class="number">2</span> ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">""</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"ERROR: 需要 3 个传参但只提供了 <span class="variable">$#</span> 个"</span> &gt;&amp;<span class="number">2</span></div><div class="line">        <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    local real_num=<span class="variable">$1</span></div><div class="line">    local formal_num=<span class="variable">$2</span></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">${formal_num}</span> <span class="operator">-ne</span> <span class="variable">${real_num}</span> ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"ERROR: 需要 <span class="variable">${formal_num}</span> 个参数但只提供了 <span class="variable">${real_num}</span> 个"</span> &gt;&amp;<span class="number">2</span></div><div class="line">        <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"># 处理文件下载失败</span></div><div class="line">function <span class="function"><span class="title">download_err</span></span>()</div><div class="line">{</div><div class="line">    check_arg_num <span class="variable">$#</span> <span class="number">1</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"ERROR: 文件 <span class="variable">$1</span> 下载失败"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"># 处理文件夹创建失败</span></div><div class="line">function <span class="function"><span class="title">create_dir_err</span></span>()</div><div class="line">{</div><div class="line">    check_arg_num <span class="variable">$#</span> <span class="number">1</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">""</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"ERROR: 文件夹 <span class="variable">$1</span> 创建失败"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>完成之后，我们就可以在我们的 tiny_tester.sh 中例用这几个函数实现程序文件和词表文件的下载：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">check_file ./lib/utils.sh</div><div class="line"><span class="built_in">source</span> ./lib/utils.sh</div><div class="line"></div><div class="line">create_dir <span class="variable">${TMP_PATH}</span> || create_dir_err</div><div class="line"><span class="built_in">cd</span> <span class="variable">${TMP_PATH}</span></div><div class="line">download <span class="variable">${PACKAGE_PATH}</span> || download_err <span class="variable">${PACKAGE_PATH}</span></div><div class="line">download <span class="variable">${WORDS_PATH}</span> || download_err <span class="variable">${WORDS_PATH}</span></div></pre></td></tr></table></figure></p>
<p>紧接着可以解压程序的压缩包：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="constant">PROJECT_FILE</span>=<span class="variable">$(</span>basename <span class="variable">${</span><span class="constant">PACKAGE_PATH</span>})			<span class="comment"># 待测程序压缩包的文件名</span></div><div class="line"><span class="constant">PROJECT_NAME</span>=<span class="variable">$(</span>basename <span class="variable">${</span><span class="constant">PACKAGE_PATH</span>} .tar.gz)	<span class="comment"># 待测程序包解压后的目录名</span></div><div class="line">tar -xzf <span class="variable">${</span><span class="constant">PROJECT_FILE</span>} || unachive_err</div></pre></td></tr></table></figure></p>
<p>类似的，<code>unachive_err</code> 用于处理文件解压失败：</p>
<p><figure class="highlight"><figcaption><span>check_helper.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 处理文件解压失败</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">unarchive_err</span><span class="params">()</span></span></div><div class="line">{</div><div class="line">    check_arg_num $<span class="comment"># 1</span></div><div class="line">    <span class="keyword">echo</span> <span class="string">""</span></div><div class="line">    <span class="keyword">echo</span> <span class="string">"ERROR: 文件 $1 解压失败"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<h3 id="服务器本地化配置">服务器本地化配置</h3>
<p>接下来对服务器进行本地化配置。示例程序的配置项很简单，只有一个端口参数。我们可以编写一个交互式的配置方式：允许用户在运行测试时指定要使用的端口号。当检测到端口号被占用时，再次提示用户指定一个新的端口号。</p>
<p>我们先实现一个端口占用检查的函数 <code>port_query</code> 。原理很简单，就是判断 <code>netstat -an</code> 命令返回的结果中是否存在用户指定的端口号：</p>
<p><figure class="highlight"><figcaption><span>check_helper.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 判断指定端口号是否已被占用</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">port_query</span><span class="params">()</span></span></div><div class="line">{</div><div class="line">    check_arg_num $<span class="comment"># 1</span></div><div class="line">    local port=$<span class="number">1</span></div><div class="line">    netstat -an | awk <span class="string">'/^tcp/ {print $4;}'</span> | grep ${port} &gt; /dev/<span class="keyword">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div><div class="line">    <span class="keyword">return</span> $?</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"># 处理本地化配置失败</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">localize_config_err</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">echo</span> <span class="string">""</span></div><div class="line">    <span class="keyword">echo</span> <span class="string">"ERROR: 本地化配置失败"</span> &gt;&amp;<span class="number">2</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>之后，继续编写一个函数 <code>localize_config_port</code> 用来完成端口号配置：</p>
<p><figure class="highlight"><figcaption><span>utils.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##! 本地化配置 - 配置端口号</span></div><div class="line"><span class="comment">##! @TODO: 加入端口必须是纯数字的验证</span></div><div class="line"><span class="comment">##! @AUTHOR: panweizhou</span></div><div class="line"><span class="comment">##! @VERSION: 1.0</span></div><div class="line"><span class="comment">##! @IN: $1 =&gt; config_file</span></div><div class="line"><span class="comment">##! @OUT: 0 =&gt; success; 1 =&gt; failure</span></div><div class="line">function <span class="function"><span class="title">localize_config_port</span></span>()</div><div class="line">{</div><div class="line">    check_arg_num <span class="variable">$#</span> <span class="number">1</span></div><div class="line"></div><div class="line">    local config_file=<span class="variable">$1</span></div><div class="line">    local port=$(grep <span class="string">'^port'</span> <span class="variable">${config_file}</span> | awk -F<span class="string">':'</span> <span class="string">'{print $2;}'</span> | tr <span class="operator">-d</span> <span class="string">' '</span>)</div><div class="line">    local <span class="keyword">done</span>_flag=<span class="number">0</span></div><div class="line">    local new_port</div><div class="line">    <span class="keyword">while</span> [ <span class="variable">${done_flag}</span> <span class="operator">-ne</span> <span class="number">1</span> ]</div><div class="line">    <span class="keyword">do</span></div><div class="line">        <span class="built_in">echo</span> -n <span class="string">"输入你希望使用的端口号（默认为<span class="variable">${port}</span>）："</span></div><div class="line">        <span class="built_in">read</span> new_port</div><div class="line">        <span class="keyword">if</span> [ -z <span class="variable">${new_port}</span> ]</div><div class="line">        <span class="keyword">then</span></div><div class="line">            new_port=<span class="variable">${port}</span></div><div class="line">        <span class="keyword">fi</span></div><div class="line">        <span class="comment"># 检查端口是否被占用，如果是，则修改端口号</span></div><div class="line">        port_query <span class="variable">${new_port}</span></div><div class="line">        <span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ]</div><div class="line">        <span class="keyword">then</span></div><div class="line">            <span class="built_in">echo</span> <span class="string">"WARNING: 端口号 <span class="variable">${new_port}</span> 已被占用"</span> &gt;&amp;<span class="number">2</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="comment"># 将结果写入配置文件</span></div><div class="line">            <span class="built_in">echo</span> <span class="string">"port: <span class="variable">${new_port}</span>"</span> &gt; <span class="variable">${config_file}</span></div><div class="line">            <span class="keyword">return</span> $?</div><div class="line">            <span class="keyword">done</span>_flag=<span class="number">1</span></div><div class="line">        <span class="keyword">fi</span></div><div class="line">    <span class="keyword">done</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>该函数传入配置文件的存放路径，并读取里头的配置作为默认端口号。之后询问用户给定一个新的端口号。当检测到端口号已被占用时，就提醒用户重新选择其他端口号。</p>
<p>到此可以完成服务器的配置：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 对 port 和 data_path 两项配置进行本地化</span></div><div class="line">PROJECT_PATH=<span class="variable">${TMP_PATH}</span>/<span class="variable">${PROJECT_NAME}</span></div><div class="line">CONFIG_FILE=<span class="variable">${PROJECT_PATH}</span>/conf/server.conf	<span class="comment"># 待测服务器程序配置文件</span></div><div class="line">localize_config_port <span class="variable">${PROJECT_PATH}</span> || localize_config_err</div></pre></td></tr></table></figure></p>
<h2 id="压力测试">压力测试</h2>
<p>完成服务器的本地部署后，压力测试就是在本地启动服务器，然后向其发送请求的过程。发送请求主要用到的工具是 <code>curl</code> 命令。</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 后台启动待测服务器程序</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">"启动待测服务器..."</span></div><div class="line"><span class="built_in">cd</span> <span class="variable">${PROJECT_PATH}</span></div><div class="line">./bin/mini_http_server &amp;</div><div class="line"><span class="keyword">if</span> [ $? <span class="operator">-ne</span> <span class="number">0</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">     server_run_err</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="comment"># 获取服务器的pid</span></div><div class="line">SERVER_PID=$!</div><div class="line"><span class="built_in">echo</span> <span class="string">" OK (PID: <span class="variable">${SERVER_PID}</span>; PORT: <span class="variable">${PORT}</span>)"</span></div><div class="line"></div><div class="line"><span class="comment"># 读取请求数据，每次一行</span></div><div class="line"><span class="comment"># 向服务器发送请求</span></div><div class="line">WORDS_FILE=<span class="variable">${TMP_PATH}</span>/$(basename <span class="variable">${WORDS_PATH}</span>)</div><div class="line"><span class="built_in">echo</span> -n <span class="string">"以 <span class="variable">${QPS}</span>qps 向测试服务器发送请求 "</span></div><div class="line"><span class="keyword">while</span> <span class="built_in">read</span> QUERY</div><div class="line"><span class="keyword">do</span></div><div class="line">    QUERY=<span class="string">"http://127.0.0.1:<span class="variable">${PORT}</span><span class="variable">${QUERY}</span>"</span></div><div class="line">    <span class="comment"># 发送请求，并将结果写入文件</span></div><div class="line">    curl --retry <span class="number">3</span> <span class="operator">-s</span> <span class="variable">${QUERY}</span> &gt;&gt; <span class="variable">${RESPONSE_PATH}</span></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">${QUERY_PERCENT}</span> <span class="operator">-eq</span> <span class="number">0</span> ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> -n <span class="string">"*"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    sleep <span class="variable">${INTERVAL}</span>s</div><div class="line"><span class="keyword">done</span> &lt; <span class="variable">${WORDS_FILE}</span></div><div class="line"><span class="built_in">echo</span> <span class="string">" OK"</span></div></pre></td></tr></table></figure></p>
<p>上面的例子用的请求是 get 请求。而对于 post 请求，可以使用 <code>curl -d</code> ，后面跟着几个请求参数和 url 即可。</p>
<p>如果词表数量太大，整个过程可能耗时比较长，所以可以改一下上面的代码第 12 行之后的部分，实现一条进度条：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 读取请求数据，每次一行</span></div><div class="line"><span class="comment"># 向服务器发送请求</span></div><div class="line">WORDS_FILE=<span class="variable">${TMP_PATH}</span>/$(basename <span class="variable">${WORDS_PATH}</span>)</div><div class="line">QUERY_NUM=$(wc <span class="operator">-l</span> <span class="variable">${WORDS_FILE}</span> | awk <span class="string">'{print $1}'</span>)</div><div class="line">QUERY_BASE=$(expr <span class="variable">${QUERY_NUM}</span> / <span class="number">10</span>)</div><div class="line">QUERY_COUNTER=<span class="number">0</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">"以 <span class="variable">${QPS}</span>qps 向测试服务器发送请求 "</span></div><div class="line"><span class="keyword">while</span> <span class="built_in">read</span> QUERY</div><div class="line"><span class="keyword">do</span></div><div class="line">    QUERY=<span class="string">"http://127.0.0.1:<span class="variable">${PORT}</span><span class="variable">${QUERY}</span>"</span></div><div class="line">    <span class="comment"># 发送请求，并将结果写入文件</span></div><div class="line">    curl --retry <span class="number">3</span> <span class="operator">-s</span> <span class="variable">${QUERY}</span> &gt;&gt; <span class="variable">${RESPONSE_PATH}</span></div><div class="line">    QUERY_COUNTER=$(expr <span class="variable">${QUERY_COUNTER}</span> + <span class="number">1</span>)</div><div class="line">    QUERY_PERCENT=$(expr <span class="variable">${QUERY_COUNTER}</span> % <span class="variable">${QUERY_BASE}</span>)</div><div class="line">    <span class="keyword">if</span> [ <span class="variable">${QUERY_PERCENT}</span> <span class="operator">-eq</span> <span class="number">0</span> ]</div><div class="line">    <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> -n <span class="string">"*"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    sleep <span class="variable">${INTERVAL}</span>s</div><div class="line"><span class="keyword">done</span> &lt; <span class="variable">${WORDS_FILE}</span></div><div class="line"><span class="built_in">echo</span> <span class="string">" OK"</span></div></pre></td></tr></table></figure></p>
<p>这样，每达到 10 个百分比，就会在终端中打印一个 <code>*</code> 字符，直到打完 10 个 <code>*</code>，即进度达到 100% 结束为止。</p>
<h2 id="解析服务器日志">解析服务器日志</h2>
<p>完成所有的请求发送和接收后，可以通过分析服务器的日志来统计成功率等信息。假定 myserver 的日志格式如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NOTICE: 01-16 17:28:17: myserver [src/worker.cpp:162]ip=127.0.0.1 succ=1 method=GET url=/whatever/xxx name=i94Q8o8 id=29279 value=1048327232.000000 </div><div class="line">NOTICE: 01-16 17:32:02: myserver [src/worker.cpp:162]ip=127.0.0.1 succ=1 method=GET url=/whatever/yyy name=TswcjgPDvzkaiY id=54015 value=806124928.000000</div></pre></td></tr></table></figure></p>
<p>假定我们需要统计以下几个结果 <span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>这里列举的几个项目只是示例，在实际的项目中，根据需求的不同，所需要统计的项目也不同。此外，不同的服务器程序日志格式不同，所记录的数据也千差万别。所以需要具体问题具体分析。 </span></span></span>：</p>
<ul>
<li><strong>value_avg</strong>：value平均值，那些value字段为空的日志不参与统计</li>
<li><strong>succ_rate</strong>：成功率，请求成功数在请求总数中的占比</li>
<li><strong>name_num</strong>：name总数（相同的name只计算一次）</li>
</ul>
<p>对日志的解析，最方便的工具是利用 <code>awk</code> 。我们可以编写一个 awk 脚本 lib/log_parser.awk 专门进行日志解析：</p>
<p><figure class="highlight"><figcaption><span>log_parser</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">##! 用于日志解析的 awk 脚本</span></div><div class="line"><span class="comment">##！@TODO: </span></div><div class="line"><span class="comment">##! @VERSION: 1.0</span></div><div class="line"><span class="comment">##! @AUTHOR: panweizhou</span></div><div class="line"><span class="comment">##! @PREV: ./mini_tester.sh</span></div><div class="line"></div><div class="line">BEGIN {</div><div class="line">    <span class="variable">query_num =</span> <span class="number">0</span></div><div class="line">    <span class="variable">succ_num =</span> <span class="number">0</span></div><div class="line">    <span class="variable">total_value =</span> <span class="number">0</span></div><div class="line">    <span class="variable">name_num =</span> <span class="number">0</span></div><div class="line">    name_array[<span class="number">1</span>] = <span class="number">0</span></div><div class="line">}</div><div class="line"></div><div class="line">{</div><div class="line">    <span class="keyword">if</span> (<span class="variable">NF =</span>= <span class="number">10</span>) {</div><div class="line">        <span class="variable">query_num =</span> query_num + <span class="number">1</span></div><div class="line">        split($<span class="number">5</span>, succ_cell, <span class="string">"="</span>)</div><div class="line">        <span class="keyword">if</span> (succ_cell[<span class="number">2</span>] == <span class="string">"1"</span>) {</div><div class="line">            <span class="comment"># 成功返回数据，则成功次数加1</span></div><div class="line">            <span class="variable">succ_num =</span> succ_num + <span class="number">1</span>; </div><div class="line">            <span class="comment"># 累加 value</span></div><div class="line">            split($<span class="number">10</span>, value_cell, <span class="string">"="</span>)</div><div class="line">            <span class="variable">total_value =</span> total_value + value_cell[<span class="number">2</span>]</div><div class="line">            <span class="comment"># 统计 name 次数，并避免重复</span></div><div class="line">            <span class="variable">duplicate_flag =</span> <span class="number">0</span></div><div class="line">            split($<span class="number">8</span>, name_cell, <span class="string">"="</span>)</div><div class="line">            for (name <span class="keyword">in</span> name_array) {</div><div class="line">                <span class="keyword">if</span> (<span class="variable">name =</span>= name_cell[<span class="number">2</span>]) {</div><div class="line">                    <span class="variable">duplicate_flag =</span> <span class="number">1</span></div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keyword">if</span> (<span class="variable">duplicate_flag =</span>= <span class="number">0</span>) {</div><div class="line">                <span class="variable">name_num =</span> name_num + <span class="number">1</span></div><div class="line">                name_array[name_num] = name_cell[<span class="number">2</span>]</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line">END {</div><div class="line">    printf <span class="string">"value_avg=%f\n"</span>, total_value / succ_num</div><div class="line">    printf <span class="string">"succ_rate=%f\n"</span>, succ_num / query_num</div><div class="line">    printf <span class="string">"name_num=%d\n"</span>, name_num</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>可以直接在我们的 tiny_tester.sh 中通过 <code>awk -f</code> 调用上面的脚本：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">LOG_FILE=<span class="variable">${PROJECT_PATH}</span>/log/server.log		<span class="comment"># 待测服务器程序日志文件</span></div><div class="line">check_file <span class="variable">${LOG_FILE}</span></div><div class="line">awk <span class="operator">-f</span> <span class="variable">${CUR_PATH}</span>/lib/log_parser.awk <span class="variable">${LOG_FILE}</span> &gt;&gt; <span class="variable">${RESULT_PATH}</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"-------------------------"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"测试结果"</span></div><div class="line">cat <span class="variable">${RESULT_PATH}</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"-------------------------"</span></div></pre></td></tr></table></figure></p>
<p>生成的报表如下所示：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-------------------------</div><div class="line">测试结果</div><div class="line">value_avg=123.123 </div><div class="line">succ_rate=0.83</div><div class="line">name_num=7654</div><div class="line">-------------------------</div></pre></td></tr></table></figure></p>
<p>到此，我们的 tiny_tester.sh 的主要任务就完成了。最后别忘了做一些收尾工作，清除临时文件，并结束服务器进程：</p>
<p><figure class="highlight"><figcaption><span>tiny_tester.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 清除临时文件</span></div><div class="line"><span class="built_in">echo</span> <span class="string">""</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">"清除临时文件..."</span></div><div class="line"><span class="keyword">if</span> [ <span class="operator">-d</span> <span class="variable">${TMP_PATH}</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    rm -r <span class="variable">${TMP_PATH}</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">echo</span> <span class="string">" OK"</span></div><div class="line"></div><div class="line"><span class="comment"># 结束服务器进程</span></div><div class="line"><span class="built_in">echo</span> -n <span class="string">"关闭服务器..."</span></div><div class="line">kill -<span class="number">2</span> <span class="variable">${SERVER_PID}</span> &gt; /dev/null || server_kill_err</div><div class="line"><span class="built_in">echo</span> <span class="string">" OK"</span></div><div class="line"></div><div class="line"><span class="built_in">cd</span> <span class="variable">${CUR_PATH}</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">""</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"测试完成。再见！"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">""</span></div></pre></td></tr></table></figure></p>

		</div>

		<!-- bdshare -->
		
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"5","bdPos":"left","bdTop":"100"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


        

		<!-- pagination -->
		<div>
		<center>
		<div class="pagination">
	 
      <ul>
		
		<li class="prev"><a data-pjax href="/codes/fcevm/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

		<li><a data-pjax href="/archive"><i class="fa fa-archive"></i>Archive</a></li>

        
			<li class="next"><a data-pjax href="/codes/godeyes-intro/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>           
      </ul>
	
</div>

	        </center>
		</div>

        <!-- donate -->
        <!-- Donate Module -->
<div id="donate_module">
	<!-- css -->
	<style type="text/css">
		.donate_bar a.btn_donate{
			display: inline-block;
			width: 82px;
			height: 82px;
			background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			_background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			<!-- 因为本 hexo 生成的博客所用的 theme 的 a:hover 带动画效果，
				 为了在让打赏按钮显示效果正常 而 添加了以下几行 css，
				 嵌入其它博客时不一定要它们。 -->
			-webkit-transition: background 0s;
			-moz-transition: background 0s;
			-o-transition: background 0s;
			-ms-transition: background 0s;
			transition: background 0s;
			<!-- /让打赏按钮的效果显示正常 而 添加的几行 css 到此结束 -->
		}
		.donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
		.donate_bar .donate_txt {
			display: block;
			color: #9d9d9d;
			font: 14px/2 "Microsoft Yahei";
		}
		.bold{ font-weight: bold; }
	</style>
	<!-- /css -->
	<!-- btn_donate & tips -->
	<div id="donate_board" class="donate_bar center">
		<a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
	</div>
	<!-- /btn_donate & tips -->
	<!-- donate guide -->
	<div id="donate_guide" class="donate_bar center hidden">
        <div class="row center">
		<a href="/images/misc/alipay.png" title="Alipay_Scan_Payment" class="fancybox">
			<img src="/images/misc/alipay.png" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>&nbsp;
		<a href="/images/misc/wechatpay.jpeg" title="WeChat_Scan_Payment" class="fancybox">
			<img src="/images/misc/wechatpay.jpeg" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>
        </div>
		<span class="donate_txt">
			Use App <span class="bold"><a href="http://global.alipay.com/ospay/home.htm">Alipay</a> / <a href="http://www.wechat.com/en/">WeChat</a></span>
			to scan QRCode~ Thx for your support.<br/>
			用手机 <span class="bold"><a href="https://mobile.alipay.com/index.htm">支付宝钱包</a> / <a href="http://weixin.qq.com/">微信</a></span>，
			扫一扫即可~ 谢谢您的鼓励。<br/>
			<br/>
		</span>
		<br/>
	</div>
	<!-- /donate guide -->
	<!-- donate script -->
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
	<!-- /donate script -->
</div>
<!-- /Donate Module -->


		<!-- toc -->
		
   	<script type="text/javascript">
		jQuery(document).ready(function() {
				
		   generatePostTOC('.mypage',  2 , 2 );
		
		});
	</script>




		<!-- comment -->
		
<section id="comment">
    <h2 class="title">Comments</h2>
	
	 <div id="comment-thread"></div>
	 <div id="loading-spin"></div>
	 <script type="text/javascript">
	   getComments({
		       type: "github",
	           user: "wzpan",
	           repo: "wzpan.github.io",
			   client_id: "1eb35434de75c06a513f",
			   client_secret: "6e4193f8ecd619cdfac2b1aa16b3663fe18d2e90",
			   no_comment: "暂时还没有留言呢，点击下面的按钮去留言吧！",
			   go_to_comment: "去留言",
			   btn_class: "btn btn-primary",
			   no_issue: "no_issue",
			   issue_title: "Write a Tiny Shell-based Test Framework",
			   issue_id: "undefined",
			   comments_target: "#comment-thread" ? "#comment-thread" : "#comment-thread",
			   loading_target: "undefined"
			   });
	 </script>
	
</section>



		
	</div> <!-- span9/span12 -->
	
		<div class="span3">

	<!-- donate -->
	<div class="meta-widget">
	<a href="#donate_module" id="a_donate" class="a_donate"><i class="fa fa-smile-o"></i> Donate this article</a>
	</div>

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	Jan 15 2015 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a data-pjax href="/categories/codes/">codes<span>36</span></a></li>
  </li>

    </ul>
	</div>
	
	
  	<!-- tags -->
	
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a data-pjax href="/tags/shell/">shell<span>3</span></a></li> <li><a data-pjax href="/tags/Testing/">Testing<span>2</span></a></li>

    </ul>
	</div>
		
	
    <hr>
</div><!-- span3 -->

<!-- donate script -->
	<script type="text/javascript">
		document.getElementById('a_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
	

</div><!-- row-fluid post-full -->

	</div>	
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 Joseph Pan
  
    <small>
     <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="/images/license.png"></a>
    </small>
</p>
 </footer>
</div> <!-- container-narrow -->


<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/dist/jquery.imagesloaded.min.js"></script>


<script src="/dist/gallery.min.js"></script>
<script src="/dist/bootstrap.min.js"></script>
<script src="/dist/jquery.tableofcontents.min.js"></script>
<script src="/dist/tocgenerator.min.js"></script>
<script src="/dist/require.min.js"></script>
<script src="/dist/main.min.js"></script>



<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox({
    helpers : { 
        title : { type : 'inside' }
    },
    afterLoad : function() {
        this.title = (this.title ? '' + this.title + '<br />' : '') + 'Image ' + (this.index + 1) + ' of ' + this.group.length;
    }
  });
})(jQuery);
</script>




<!-- syntax highlighting -->

  <script>
  marked.setOptions({
    highlight: function (code, lang) {
        return hljs.highlightAuto(code).value;
    }
  });
  function Highlighting(){
    var markdowns = document.getElementsByClassName('markdown');
    for(var i=0;i<markdowns.length;i++){
        if(markdowns[i].innerHTML) markdowns[i].innerHTML =marked(markdowns[i].innerHTML);
    }
  }
  window.addEventListener('DOMContentLoaded', Highlighting, false);
  window.addEventListener('load', Highlighting, false);
  </script>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

  _st('install','ney3Rb77vMaWT2KUKFyt');
</script>



</body>
</html>
