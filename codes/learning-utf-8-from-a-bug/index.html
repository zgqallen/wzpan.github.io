<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Learning UTF-8 From A Bug | HaHack</title>
  <meta name="author" content="Joseph Pan">
  
  <meta name="description" content="从一个 bug ，引出 UTF-8 编码的讨论。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Learning UTF-8 From A Bug"/>
  <meta property="og:site_name" content="HaHack"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/images/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="HaHack" type="application/atom+xml">
  
  <link rel="stylesheet" href="/dist/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bootstrap-responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/font-awesome.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/style.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/highlight.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/sidenav.min.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/dist/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bubble.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/google-fonts.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/nprogress.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/timeline-comment.min.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<!--  -->
<!--     <link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow|PT+Sans:400,400italic,700,700italic|Droid+Serif:400,400italic' rel='stylesheet' type='text/css'> -->
<!--     <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'> -->
<!--  -->
  
<script src="/dist/jquery-2.0.3.min.js"></script>


    <script src="/dist/videoGFW.min.js"></script>
	
	


    <script src="/dist/github-comment.js"></script>
    <script src="/dist/markdown.min.js"></script>
    <script src="/dist/timeago.min.js"></script>
	<script src="/dist/spin.min.js"></script>


</head>


<body data-spy="scroll" data-target=".toc">  
  <header id="header" class="inner"><div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
            <a data-pjax class="brand" href="/">HaHack</a>
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="nav-collapse collapse">
            <ul class="nav">				
			    
				   <li><a data-pjax href="/archive" title="所有文章归档"><i class="fa fa-archive"></i>Archive</a></li>				   			    			
				   <li><a data-pjax href="/categories" title="所有文章分类"><i class="fa fa-folder"></i>Categories</a></li>				   			    			
				   <li><a data-pjax href="/tags" title="所有文章标签"><i class="fa fa-tags"></i>Tags</a></li>				   			    			
				
				<li class="divider-vertical"></li>
			   	<li><a data-pjax href="/wiki" title="我的笔记库"><i class="fa fa-tasks"></i>wiki</a></li>				   
				
            </ul>			
			<ul class="nav navright">
				<li class="dropdown">
				<a data-pjax href="#" title="订阅本站" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-rss"></i>Subscribe <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/atom.xml" title="使用 RSS 阅读器订阅 HaHack"><i class="fa fa-rss-square"></i>RSS</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/wechat.html" title="订阅 HaHack 的公众平台"><i class="fa fa-qrcode"></i>WeChat</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="http://toutiao.io/u/147640" title=""><i class="fa fa-align-justify"></i>Toutiao</a></li>
				
                	        </ul>
				</li>
				
				<li><a data-pjax href="/about" title="关于我"><i class="fa fa-user"></i>About</a></li>				   				
   					  
            </ul>
            </div> <!-- nav-collapse collapse -->
        </div> <!-- container -->
     </div> <!-- navbar-inner -->
</div> <!-- navbar navbar-inverse -->
</header>
  <div class="container" id="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> Learning UTF-8 From A Bug</h1>
		</div>    
	





<div class="row-fluid post">
	<!-- span -->
	
	<div class="span9">
	

	<!-- <div class="alert alert-error">
	<button type="button" class="close" data-dismiss="alert">&times;</button>
	<i class="fa fa-gift"></i> 过年了，<a href="/donate.html" target="_blank">给HaHack派个红包吧</a>！
</div> -->

	
		<div class="alert alert-success">
			<i class="fa fa-info-circle"></i> <p>从一个 bug ，引出 UTF-8 编码的讨论。</p>

		</div> <!-- alert -->
	
		   

		<!-- content -->
		<div class="mypage">
		<p>去年 8 月份，我尝试自己写代码解析 <a href="https://www.kernel.org/doc/man-pages/" target="_blank" rel="external">Linux Man-Pages</a> 的页面。</p>
<p>Man-Pages 使用的是 <a href="http://web.cecs.pdx.edu/~trent/gnu/groff/groff_toc.html" target="_blank" rel="external">groff</a> 文本标记语言，其最大的特色就是格式标记宏置于行首，例如 man(7) 第 35~48 的内容为：</p>
<p><figure class="highlight groff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">.SH NAME</div><div class="line">man \- macros to format man pages</div><div class="line">.SH SYNOPSIS</div><div class="line">.B groff \-Tascii \-man</div><div class="line">.I file</div><div class="line">\&<span class="keyword">...</span></div><div class="line">.LP</div><div class="line">.B groff \-Tps \-man</div><div class="line">.I file</div><div class="line">\&<span class="keyword">...</span></div><div class="line">.LP</div><div class="line">.B man</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>每一行开头出现的字段就是标记宏，依次的含义为：</p>
<table>
<thead>
<tr>
<th>宏</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.SH</code></td>
<td>标题</td>
</tr>
<tr>
<td><code>.B</code></td>
<td>加粗</td>
</tr>
<tr>
<td><code>.I</code></td>
<td>斜体</td>
</tr>
<tr>
<td><code>.LP</code></td>
<td>开始段落</td>
</tr>
</tbody>
</table>
<p>经过解析后，这段文本在 man 程序里看起来会是这个样子<span class="margin-note-marker"><sup>1</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">1</span>当然，<code>.B</code>、<code>.I</code> 的效果在代码框里无法显示。 </span></span></span>：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NAME</div><div class="line">    man [section] title</div><div class="line"></div><div class="line">SYNOPSIS</div><div class="line">    groff -Tascii -man file ...</div><div class="line"></div><div class="line">    groff -Tps -man file ...</div></pre></td></tr></table></figure></p>
<p>既然是 *nix 的产物，我在写代码解析这些文件的时候，第一反应就是使用 UTF-8 编码。<span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><img src="/images/learning-utf-8-from-a-bug/unicode.png" alt=" Unicode Logo"><b>图 1</b>  Unicode Logo</span></span></span></p>
<p>什么是 UTF-8 编码？这得从计算机如何表达文本说起。当人们说起“文本”，他们通常指显示在屏幕上的字符或者其他的记号；但是计算机不能直接处理这些字符和标记；它们只认识位（bit）和字节（byte）。</p>
<p>实际上，从屏幕上的每一块文本都是以某种字符编码（character encoding）的方式保存的。粗略地说就是，字符编码提供一种映射，使屏幕上显示的内容和内存、磁盘内存储的内容对应起来。有许多种不同的字符编码，有一些是为特定的语言，比如俄语、中文或者英语，设计、优化的，另外一些则可以用于多种语言的编码。</p>
<p>早在 1963 年，ANSI 发布了基于电报码的 ASCII 字符编码，它用 7 位 (bit) 表示了 27 = 128 个字符，只能勉强覆盖英文字符。后来随着电脑技术的传播，人们呼吁把字符编码扩充到 8 位也就是一个字节 (byte) ，可以涵盖 28 = 256 个字符。于是 ISO 在 1980 年代中期推出了 ISO 8859，256 个字符显然也不能满足需要，所以 8859 被分为十几个部分：从 8859-1 (西欧语言) 、8859-2 (中欧语言) ，直到 8859-16 (东南欧语言) ，覆盖了大部分使用拉丁字母的语言文字。</p>
<p>但人类的语言文字种类实在复杂，即使是 ISO 8859-16 也无法表达很多地区的文字。在这前后还出现了很多编码，例如 IBM 的 OEM 代码页、微软的 ANSI 代码页，还有中国大陆的 GB2312 和 GBK ，等等。人们也逐渐认识到编码不统一带来的种种不便。于是 ISO 和 统一码联盟合作推出了 Unicode 编码，Unicode 编码系统为表达任意语言的任意字符而设计。Unicode 编码一共提出了三种版本：</p>
<ul>
<li>最早的版本是 <strong>UTF-32</strong>，它使用 4 字节的数字来表达每个字母、符号，或者表意文字(ideograph)。虽然这种编码方式可以在常数时间内定位字符串里的第 N 个字符，但每个字符都要用 4 个字节来表示，实在有些浪费；</li>
<li>之后提出了 <strong>UTF-16</strong> ，将最常用的 65535 个字符用 2 个字节表示，其他 Unicode 字符则使用另外一种映射方式。UTF-16 编码最明显的优点是它在空间效率上比 UTF-32 高两倍。不过，最常用的字符用 2 个字节来表示，还是有些浪费，特别是要处理许多 ASCII 字符时<span class="margin-note-marker"><sup>2</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">2</span>如果仔细想想，一个中文网页也会包含许多的 ASCII 字符。</span></span></span>。</li>
<li>于是人们又提出了 <strong>UTF-8</strong> 。UTF-8 是一种为 Unicode 设计的变长（variable-length）编码系统。即，不同的字符可使用不同数量的字节编码。对于 ASCII 字符，utf-8 仅使用 1 个字节来编码 <span class="margin-note-marker"><sup>3</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">3</span>事实上，UTF-8 中前 128 个字符（0–127）使用的是跟 ASCII 一样的编码方式。 </span></span></span>。像 ñ 和 ö 这样的扩展拉丁字符则使用 2 个字节来编码。中文字符比如“中”则占用了 3 个字节。很少使用的“星芒层字符”则占用 4 个字节。</li>
</ul>
<p>IETF 要求所有网络协议都支持 UTF-8，互联网电子邮件联盟 (Internet Mail Consortium，IMC) 也建议所有电子邮件软件都支持 UTF-8，所以它已成为互联网上的事实标准。*nix 系统中的默认文件编码也是 UTF-8。这也是为什么我第一反应是使用 UTF-8 编码来解析所有 Man-Pages 文件。</p>
<p>然而，出乎我意料的是，我的代码在对这些文件的解析过程中会间歇性遇到 <code>UnicodeDecodeError</code> 错误。很快我就确定这些导致出错的文件一定是使用了其他的编码方式。导致这个情况的原因也可想而知 —— 这些文档的编写者遍布世界各地，可能使用了不同的本地化编码方案，从而编码方式也参差不齐。然而，这种情况并不是一件好事。文档编码的混乱会给文档解析带来不便。</p>
<p>发现了这个问题后，我访问了 Linux Man-Pages 项目的 <a href="http://bugzilla.kernel.org/enter_bug.cgi?product=Documentation" target="_blank" rel="external">bugzilla</a> 页面。通过搜索，并没有人提出过类似的问题。于是我决定给该项目提交 bug 。</p>
<p><span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><img src="/images/learning-utf-8-from-a-bug/linux-man-pages.png" alt=" Linux Man Pages"><b>图 2</b>  Linux Man Pages</span></span></span></p>
<p>我写了个 Python 脚本，用于找出所有不是使用 UTF-8 编码的文档：</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/bin/python3</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> os.path</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mdata</span><span class="params">(folder)</span>:</span></div><div class="line">    file_list = os.listdir(folder)</div><div class="line">    <span class="keyword">for</span> a_file <span class="keyword">in</span> file_list:</div><div class="line">        a_file = os.path.join(folder, a_file)</div><div class="line">        <span class="keyword">if</span> os.path.isdir(a_file):</div><div class="line">            mdata(a_file)  <span class="comment"># 递归遍历所有目录</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">with</span> open(a_file, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> fread:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">                   line = fread.readline()</div><div class="line">                   <span class="keyword">if</span> <span class="keyword">not</span> line:</div><div class="line">                        <span class="keyword">break</span></div><div class="line">            <span class="keyword">except</span> UnicodeDecodeError:</div><div class="line">                print(<span class="string">"{0}\n"</span>.format(a_file))</div><div class="line"></div><div class="line">mdata(<span class="string">'man-pages'</span>)</div></pre></td></tr></table></figure></p>
<p>我的方法是直接使用 UTF-8 编码来递归遍历所有文档，如果遇到无法使用 Unicode 解析的字符，则将该文件打印出来。</p>
<p>得到这类文件的列表后，我就将这个列表连同说明 <a href="https://bugzilla.kernel.org/show_bug.cgi?id=60807" target="_blank" rel="external">提交了上去</a>：</p>
<p><blockquote>

<p>I found that not all the pages are encoded using utf-8. It may cause problems once we try to parse them.</p>
<p>These files are:</p>
<ul>
<li>man3/fflush.3</li>
<li>man3/toupper.3</li>
<li>man3/updwtmp.3</li>
<li>man3/encrypt.3</li>
<li>man3/lockf.3</li>
<li>man3/rand.3</li>
<li>man3/fclose.3</li>
<li>man3/strtok.3</li>
<li>man2/close.2</li>
<li>man2/getdomainname.2</li>
<li>man2/madvise.2</li>
<li>man2/umask.2</li>
<li>man2/sysinfo.2</li>
<li>man2/getrlimit.2</li>
<li>man5/utmp.5</li>
<li>man7/cp1251.7</li>
<li>man7/iso_8859-2.7</li>
<li>man7/armscii-8.7</li>
<li>man7/suffixes.7</li>
<li>man7/iso_8859-4.7</li>
<li>man7/iso_8859-8.7</li>
<li>man7/iso_8859-16.7</li>
<li>man7/hier.7</li>
<li>man7/iso_8859-13.7</li>
<li>man7/koi8-u.7</li>
<li>man7/environ.7</li>
<li>man7/iso_8859-15.7</li>
<li>man7/iso_8859-9.7</li>
<li>man7/iso_8859-11.7</li>
<li>man7/iso_8859-14.7</li>
<li>man7/iso_8859-10.7</li>
<li>man7/iso_8859-6.7</li>
<li>man7/iso_8859-1.7</li>
<li>man7/iso_8859-7.7</li>
<li>man7/koi8-r.7</li>
<li>man7/iso_8859-5.7</li>
<li>man7/iso_8859-3.7</li>
</ul>


<footer><strong>Weizhou Pan</strong></footer></blockquote>
</p>
<p>大概过了三个月，Man-Pages 的一位名为 Peter Schiffer 的 Contributor 写了两个脚本作为回复：</p>
<ol>
<li><a href="https://bugzilla.kernel.org/attachment.cgi?id=117641" target="_blank" rel="external">print_encoding.sh</a> - 一个可以打印出所有 Man-Pages 文件的编码的 bash 脚本；</li>
<li><a href="https://bugzilla.kernel.org/attachment.cgi?id=117651" target="_blank" rel="external">convert_to_utf_8.sh</a> - 一个可以将所有非 ASCII 编码的 Man Pages 文件转成 UTF-8 的 bash 脚本。</li>
</ol>
<p>Peter 的第一个脚本只有寥寥几行：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> <span class="operator">-lt</span> <span class="number">1</span> ]]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">${0}</span> man?/*"</span> <span class="number">1</span>&gt;&<span class="number">2</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">printf</span> <span class="string">"\n   %-23s%-19s%s\n\n"</span> <span class="string">"Man Page"</span> <span class="string">"Encoding by file"</span> \</div><div class="line">    <span class="string">"Encoding by first line"</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> [[ ! <span class="operator">-f</span> <span class="string">"<span class="variable">$f</span>"</span> ]]; <span class="keyword">then</span></div><div class="line">        <span class="keyword">continue</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    enc=$(file -bi <span class="string">"<span class="variable">$f</span>"</span> | cut <span class="operator">-d</span> = <span class="operator">-f</span> <span class="number">2</span>)</div><div class="line">    <span class="keyword">if</span> [[ <span class="variable">$enc</span> != <span class="string">"us-ascii"</span> ]]; <span class="keyword">then</span></div><div class="line">        lenc=$(head -n <span class="number">1</span> <span class="string">"<span class="variable">$f</span>"</span> | sed -n <span class="string">"s/.*coding: \([^ ]*\).*/\1/p"</span>)</div><div class="line">        <span class="built_in">printf</span> <span class="string">" * %-23s%-19s%s\n"</span> <span class="string">"<span class="variable">$f</span>"</span> <span class="string">"<span class="variable">$enc</span>"</span> <span class="string">"<span class="variable">$lenc</span>"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="keyword">exit</span> <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>其中，获取文件编码用到了 <code>file</code> 命令：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">enc=$(file -bi &lt;文件名&gt; | cut <span class="operator">-d</span> = <span class="operator">-f</span> <span class="number">2</span>)  <span class="comment"># 获取文件的编码类型，并赋给 enc 变量</span></div></pre></td></tr></table></figure></p>
<p>如果 <code>enc</code> 变量不为 ASCII 的话，那么将文件的编码格式和首行的编码信息打印出来（如果有的话）：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 获取文件首行的编码信息（如果有的话）</span></div><div class="line">lenc=$(head -n <span class="number">1</span> <span class="string">"<span class="variable">$f</span>"</span> | sed -n <span class="string">"s/.*coding: \([^ ]*\).*/\1/p"</span>)</div><div class="line"><span class="comment"># 打印这两个信息</span></div><div class="line"><span class="built_in">printf</span> <span class="string">" * %-23s%-19s%s\n"</span> <span class="string">"<span class="variable">$f</span>"</span> <span class="string">"<span class="variable">$enc</span>"</span> <span class="string">"<span class="variable">$lenc</span>"</span></div></pre></td></tr></table></figure></p>
<p>Peter 的脚本可以得到更加丰富的信息，由于检测的是非 ASCII 文件，得到的文件数量也比我的结果多一些：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">$ ./print_encoding.sh man?/*</div><div class="line"></div><div class="line">   Man Page               Encoding by file   Encoding by first line</div><div class="line"></div><div class="line"> * man2/close.<span class="number">2</span>           iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man2/getdomainname.<span class="number">2</span>   iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man2/getrlimit.<span class="number">2</span>       iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man2/madvise.<span class="number">2</span>         iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man2/mount.<span class="number">2</span>           utf-<span class="number">8</span>              </div><div class="line"> * man2/sysinfo.<span class="number">2</span>         iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man2/umask.<span class="number">2</span>           iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/encrypt.<span class="number">3</span>         iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/fclose.<span class="number">3</span>          iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/fflush.<span class="number">3</span>          iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/lockf.<span class="number">3</span>           iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/rand.<span class="number">3</span>            iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/strtok.<span class="number">3</span>          iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/toupper.<span class="number">3</span>         iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man3/updwtmp.<span class="number">3</span>         iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man4/st.<span class="number">4</span>              utf-<span class="number">8</span>              </div><div class="line"> * man5/utmp.<span class="number">5</span>            iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man7/armscii-<span class="number">8.7</span>       iso-<span class="number">8859</span>-<span class="number">1</span>         ARMSCII-<span class="number">8</span></div><div class="line"> * man7/cp1251.<span class="number">7</span>          unknown-<span class="number">8</span>bit       CP1251</div><div class="line"> * man7/environ.<span class="number">7</span>         iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man7/hier.<span class="number">7</span>            iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man7/iso_8859-<span class="number">10.7</span>     iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">10</span></div><div class="line"> * man7/iso_8859-<span class="number">11.7</span>     iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">11</span></div><div class="line"> * man7/iso_8859-<span class="number">13.7</span>     iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">7</span></div><div class="line"> * man7/iso_8859-<span class="number">14.7</span>     iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">14</span></div><div class="line"> * man7/iso_8859-<span class="number">15.7</span>     iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">15</span></div><div class="line"> * man7/iso_8859-<span class="number">16.7</span>     iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">16</span></div><div class="line"> * man7/iso_8859-<span class="number">1.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         </div><div class="line"> * man7/iso_8859-<span class="number">2.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">2</span></div><div class="line"> * man7/iso_8859-<span class="number">3.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">3</span></div><div class="line"> * man7/iso_8859-<span class="number">4.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">4</span></div><div class="line"> * man7/iso_8859-<span class="number">5.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">5</span></div><div class="line"> * man7/iso_8859-<span class="number">6.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">6</span></div><div class="line"> * man7/iso_8859-<span class="number">7.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">7</span></div><div class="line"> * man7/iso_8859-<span class="number">8.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">8</span></div><div class="line"> * man7/iso_8859-<span class="number">9.7</span>      iso-<span class="number">8859</span>-<span class="number">1</span>         ISO-<span class="number">8859</span>-<span class="number">9</span></div><div class="line"> * man7/koi8-r.<span class="number">7</span>          unknown-<span class="number">8</span>bit       KOI8-R</div><div class="line"> * man7/koi8-u.<span class="number">7</span>          unknown-<span class="number">8</span>bit       </div><div class="line"> * man7/suffixes.<span class="number">7</span>        iso-<span class="number">8859</span>-<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>Peter 的第二个脚本也很好理解，找出所有非 ASCII 编码文件，使用 <code>iconv</code> 命令转换到 UTF-8 编码：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> <span class="operator">-lt</span> <span class="number">2</span> ]]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">${0}</span> &lt;output_dir&gt; man?/*"</span> <span class="number">1</span>&gt;&<span class="number">2</span></div><div class="line">    <span class="keyword">exit</span> <span class="number">1</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">out_dir=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">shift</div><div class="line"></div><div class="line">enc_line=<span class="string">"'\\\" t -*- coding: UTF-8 -*-"</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span>; <span class="keyword">do</span></div><div class="line">    enc=$(file -bi <span class="string">"<span class="variable">$f</span>"</span> | cut <span class="operator">-d</span> = <span class="operator">-f</span> <span class="number">2</span>)</div><div class="line">    <span class="keyword">if</span> [[ <span class="variable">$enc</span> != <span class="string">"us-ascii"</span> ]]; <span class="keyword">then</span></div><div class="line">        dirn=$(dirname <span class="string">"<span class="variable">$f</span>"</span>)</div><div class="line">        basen=$(basename <span class="string">"<span class="variable">$f</span>"</span>)</div><div class="line">        new_dir=<span class="string">"<span class="variable">${out_dir}</span>/<span class="variable">${dirn}</span>"</span></div><div class="line">        <span class="keyword">if</span> [[ ! <span class="operator">-e</span> <span class="string">"<span class="variable">$new_dir</span>"</span> ]]; <span class="keyword">then</span></div><div class="line">            mkdir -p <span class="string">"<span class="variable">$new_dir</span>"</span></div><div class="line">        <span class="keyword">fi</span></div><div class="line">        <span class="keyword">case</span> <span class="string">"<span class="variable">$basen</span>"</span> <span class="keyword">in</span></div><div class="line">            iso_8859-<span class="number">11.7</span> | iso_8859-<span class="number">13.7</span>)</div><div class="line">                from_enc=<span class="variable">$enc</span></div><div class="line">                ;;</div><div class="line">            armscii-<span class="number">8.7</span> | cp1251.<span class="number">7</span> | iso_8859-*.<span class="number">7</span> | koi8-?.<span class="number">7</span>)</div><div class="line">                from_enc=<span class="string">"<span class="variable">${basen%.7}</span>"</span></div><div class="line">                ;;</div><div class="line">            *)</div><div class="line">                from_enc=<span class="variable">$enc</span></div><div class="line">                ;;</div><div class="line">        <span class="keyword">esac</span></div><div class="line">        <span class="built_in">printf</span> <span class="string">"Converting %-23s from %s\n"</span> <span class="string">"<span class="variable">$f</span>"</span> <span class="string">"<span class="variable">$from_enc</span>"</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$enc_line</span>"</span> &gt; <span class="string">"<span class="variable">${new_dir}</span>/<span class="variable">${basen}</span>"</span></div><div class="line">        iconv <span class="operator">-f</span> <span class="string">"<span class="variable">$from_enc</span>"</span> -t utf-<span class="number">8</span> <span class="string">"<span class="variable">$f</span>"</span> \</div><div class="line">            | sed <span class="string">"/.*-\*- coding:.*/d;/.\\\" t$/d"</span> &gt;&gt; <span class="string">"<span class="variable">${new_dir}</span>/<span class="variable">${basen}</span>"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="keyword">exit</span> <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>Peter 的两个脚本看起来已经足以解决编码问题了。不过这个 bug 却一直拖到了今年的情人节&amp;元宵节 <span class="margin-note-marker"><sup>4</sup></span> <span class="block margin-div-outer"><span class="block margin-div-inner"><span class="block margin-note"><span class="margin-note-marker">4</span>也有人说是缘消节？<code>&gt;_&lt;</code> </span></span></span> 才有了进一步进展。Man-Pages 项目的主要维护者 Michael Kerrisk 现身提出了两个疑问：</p>
<p><blockquote>

<p>Peter,</p>
<p>Sorry to be slow following up on this. Thanks for the scripts.</p>
<p>As some background, I’ll just note that the current encoding markers in the iso_8859* pages were added in response to this 2009 bug report:
<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=519209" target="_blank" rel="external">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=519209</a></p>
<p>It seems a reasonable idea to convert everything to UTF-8, but I have some concerns/questions.</p>
<ol>
<li>
<p>Is the encoding line: <code>'\&quot; t -*- coding: UTF-8 -*-</code> really needed, or does modern groff just work this out?</p>
</li>
<li>
<p>I’m concerned about backward compatibility issues. As in: what if someone loads the man pages onto a system with old groff. Now, as far as I can work out, groff added input unicode support in v1.20, 2009
( <a href="http://lists.gnu.org/archive/html/groff/2009-01/msg00011.html" target="_blank" rel="external">http://lists.gnu.org/archive/html/groff/2009-01/msg00011.html</a> ). So, perhaps that’s long enough ago that we don’t need to worry too much about these issues.</p>
</li>
</ol>
<p>Any thoughts?</p>


<footer><strong>Michael Kerrisk</strong></footer></blockquote>
</p>
<p>Michael 的主要疑问有两点：</p>
<ol>
<li>Peter 在每个转换后的文件开头都加入了一行编码说明行 <code>'\&quot; t -*- coding: UTF-8 -*-</code> ，这一行是否真的有必要，还是 groff 本身就可以自己判断编码？</li>
<li>对于老版本的 groff ，是否存在向下兼容问题。</li>
</ol>
<p>Michael 的疑虑不无道理。转换整个项目的编码不是一件太 trivial 的事情，小心使得万年船。他于是又在 <a href="http://thread.gmane.org/gmane.linux.man/5069" target="_blank" rel="external">linux-man</a> 邮件列表里发帖征求其他维护者的意见。</p>
<p>经过大家的讨论，后来大家达成了以下意见：</p>
<ol>
<li>编码说明行只添加进存在 UTF-8 字符的文件；</li>
<li>由于各主流操作系统都早已经更新了支持 UTF-8 编码的 groff ，因此出现兼容性问题的情况应该比较少见。</li>
</ol>
<p>两天后我收到了 Michael 发来的邮件，这个 bug 随着新版本的推出，在 2014 年 2 月 16 日被成功关闭。最新的 3.59 和 3.60 两个版本就是对针对这个 bug 的解决和后期完善。这也是我作为一个多年 Linux 用户，对这个社区所做的一个小贡献。这个过程中，我看到了这些 contributors 的严谨和负责。今后会继续努力，向他们看齐！<code>:-p</code></p>

		</div>

		<!-- jiathis -->
		
<!-- JiaThis Button BEGIN -->
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?type=left&amp;move=0&amp;btn=l2.gif&amp;uid=1538060" charset="utf-8"></script>
<!-- JiaThis Button END -->

        

		<!-- pagination -->
		<div>
		<center>
		<div class="pagination">
	 
      <ul>
		
		<li class="prev"><a data-pjax href="/codes/openframeworks-intro/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

		<li><a data-pjax href="/archive"><i class="fa fa-archive"></i>Archive</a></li>

        
			<li class="next"><a data-pjax href="/codes/opencv-and-mvc/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>           
      </ul>
	
</div>

	        </center>
		</div>

        <!-- donate -->
        <!-- Donate Module -->
<div id="donate_module">
	<!-- css -->
	<style type="text/css">
		.donate_bar a.btn_donate{
			display: inline-block;
			width: 82px;
			height: 82px;
			background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			_background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			<!-- 因为本 hexo 生成的博客所用的 theme 的 a:hover 带动画效果，
				 为了在让打赏按钮显示效果正常 而 添加了以下几行 css，
				 嵌入其它博客时不一定要它们。 -->
			-webkit-transition: background 0s;
			-moz-transition: background 0s;
			-o-transition: background 0s;
			-ms-transition: background 0s;
			transition: background 0s;
			<!-- /让打赏按钮的效果显示正常 而 添加的几行 css 到此结束 -->
		}
		.donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
		.donate_bar .donate_txt {
			display: block;
			color: #9d9d9d;
			font: 14px/2 "Microsoft Yahei";
		}
		.bold{ font-weight: bold; }
	</style>
	<!-- /css -->
	<!-- btn_donate & tips -->
	<div id="donate_board" class="donate_bar center">
		<a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
	</div>
	<!-- /btn_donate & tips -->
	<!-- donate guide -->
	<div id="donate_guide" class="donate_bar center hidden">
        <div class="row center">
		<a href="http://7xj89i.com1.z0.glb.clouddn.com/ali_pay_01.jpg" title="Alipay_Scan_Payment" class="fancybox">
			<img src="http://7xj89i.com1.z0.glb.clouddn.com/ali_pay_01.jpg" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>&nbsp;
		<a href="http://7xj89i.com1.z0.glb.clouddn.com/wechat_pay_02.png" title="WeChat_Scan_Payment" class="fancybox">
			<img src="http://7xj89i.com1.z0.glb.clouddn.com/wechat_pay_02.png" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>
        </div>
		<span class="donate_txt">
			Use App <span class="bold"><a href="http://global.alipay.com/ospay/home.htm">Alipay</a> / <a href="http://www.wechat.com/en/">WeChat</a></span>
			to scan QRCode~ Thx for your support.<br/>
			用手机 <span class="bold"><a href="https://mobile.alipay.com/index.htm">支付宝钱包</a> / <a href="http://weixin.qq.com/">微信</a></span>，
			扫一扫即可~ 谢谢您的鼓励。<br/>
			<br/>
		</span>
		<br/>
	</div>
	<!-- /donate guide -->
	<!-- donate script -->
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
		function donate_on_web(){
			$('#donate').submit();
		}
	</script>
	<!-- /donate script -->
</div>
<!-- /Donate Module -->


		<!-- toc -->
		



		<!-- comment -->
		
<section id="comment">
    <h2 class="title">Comments</h2>
	
	 <div id="github-comment"></div>
	 <div id="loading-comment"></div>
	 <script type="text/javascript">
	   getComments({
	           github_user: "wzpan",
	           github_repo: "wzpan.github.io",
			   no_comment: "暂时还没有留言呢，点击下面的按钮去留言吧！",
			   go_to_comment: "去留言",
			   no_issue: "no_issue",
			   page_title: "Learning UTF-8 From A Bug",
			   issue_id: "undefined"
			   });
	 </script>
	
</section>



		
	</div> <!-- span9/span12 -->
	
		<div class="span3">

	<!-- donate -->
	<div class="meta-widget">
	<a href="#donate_module"><i class="fa fa-smile-o"></i> Donate this article</a>
	</div>

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	Feb 20 2014 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a data-pjax href="/categories/codes/">codes<span>30</span></a></li>
  </li>

    </ul>
	</div>
	
	
  	<!-- tags -->
	
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a data-pjax href="/tags/utf-8/">utf-8<span>1</span></a></li> <li><a data-pjax href="/tags/shell/">shell<span>3</span></a></li> <li><a data-pjax href="/tags/Linux/">Linux<span>3</span></a></li>

    </ul>
	</div>
		
	
    <hr>
</div><!-- span3 -->

	

</div><!-- row-fluid post-full -->

	</div>	
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2017 Joseph Pan
  
      with help from <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and 
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254469760'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1254469760' type='text/javascript'%3E%3C/script%3E"));</script>
. 
    <small>
     <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="/images/license.png"></a>
    </small>
</p>
 </footer>
</div> <!-- container-narrow -->


<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/dist/jquery.imagesloaded.min.js"></script>


<script src="/dist/gallery.min.js"></script>
<script src="/dist/bootstrap.min.js"></script>
<script src="/dist/jquery.tableofcontents.min.js"></script>
<script src="/dist/tocgenerator.min.js"></script>
<script src="/dist/require.min.js"></script>
<script src="/dist/main.min.js"></script>


<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

  _st('install','ney3Rb77vMaWT2KUKFyt');
</script>


</body>
</html>
