<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>HTTP Web 服务 | HaHack</title>
  <meta name="author" content="Joseph Pan">
  
  <meta name="description" content="在Python 3中，可以使用一个第三方的开源库 httplib2 来处理 HTTP Web 服务。它比自带的模块 http.client 更完整的实现了http协议，同时比另一个自带的模块 urllib.request 提供了更好的抽象。例如：

Python的http库不支持缓存，而httpli">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="HTTP Web 服务"/>
  <meta property="og:site_name" content="HaHack"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/images/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="HaHack" type="application/atom+xml">
  
  <link rel="stylesheet" href="/dist/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bootstrap-responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/font-awesome.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/style.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/highlight.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/sidenav.min.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/dist/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bubble.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/google-fonts.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/nprogress.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/comment.min.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <!--[if lte IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

<!--  -->
<!--     <link href='https://fonts.googleapis.com/css?family=PT+Sans+Narrow|PT+Sans:400,400italic,700,700italic|Droid+Serif:400,400italic' rel='stylesheet' type='text/css'> -->
<!--     <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'> -->
<!--  -->
  
<script src="/dist/jquery-2.0.3.min.js"></script>


    <script src="/dist/videoGFW.min.js"></script>
	
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-41569408-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;

ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';

var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

	


    <link rel="stylesheet" href="/dist/highlight-default.min.css" media="screen" type="text/css">
    
    <script src="/dist/comment.min.js"></script>
    <script src="/dist/marked.min.js"></script>
    
    <script src="/dist/highlight.min.js"></script>
    <script src="/dist/timeago.min.js"></script>
	<script src="/dist/spin.min.js"></script>


</head>


<body data-spy="scroll" data-target=".toc">  
  <header id="header" class="inner"><div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
            <a data-pjax class="brand" href="/">HaHack</a>
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="nav-collapse collapse">
            <ul class="nav">				
			    
				   <li><a data-pjax href="/archive" title="所有文章归档"><i class="fa fa-archive"></i>Archive</a></li>				   			    			
				   <li><a data-pjax href="/categories" title="所有文章分类"><i class="fa fa-folder"></i>Categories</a></li>				   			    			
				   <li><a data-pjax href="/tags" title="所有文章标签"><i class="fa fa-tags"></i>Tags</a></li>				   			    			
				
				<li class="divider-vertical"></li>
			   	<li><a data-pjax href="/wiki" title="我的笔记库"><i class="fa fa-tasks"></i>wiki</a></li>				   
				
            </ul>			
			<ul class="nav navright">
				<li class="dropdown works">
				<a data-pjax href="#" title="作品集" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-th-large"></i>Works <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://github.com/wzpan/wukong-robot" title="wukong-robot 是一个简单、灵活、优雅的中文语音对话机器人。"><i class="fa fa-github"></i>wukong-robot</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://hahack.com/codes/dingdang-robot-intro/" title="叮当是一款可以工作在 Raspberry Pi 上的中文语音对话机器人/智能音箱项目。"><i class="fa fa-github"></i>dingdang-robot</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://www.hahack.com/codes/comment-js/" title="纯JS实现的静态站点评论系统，使用 Github/OSChina 作为 backend。"><i class="fa fa-github"></i>comment.js</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://hahack.com/codes/eulerian-video-magnification/" title="首个完整的 C++ 开源实现，能同时放大动作变化和颜色变化"><i class="fa fa-github"></i>QtEVM</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/wzpan/wzpan.github.io/wiki/hexo-series" title="为 Hexo 写的一系列主题/工具/插件"><i class="fa fa-github"></i>hexo-series</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/scnu/scnuthesis" title="符合华南师范大学硕士/博士学位论文格式要求的LaTeX模板。"><i class="fa fa-github"></i>SCNUThesis</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/wzpan/wzpan.github.io/wiki/slides" title="一些幻灯片作品"><i class="fa fa-github"></i>Slides</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://hahack.com/codes/fcevm/" title="硕士毕业论文"><i class="fa fa-github"></i>Dissertation</a></li>
				
                	        </ul>
				</li>
				<li class="dropdown">
				<a data-pjax href="#" title="订阅本站" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-rss"></i>Subscribe <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="drop2">
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/atom.xml" title="使用 RSS 阅读器订阅 HaHack"><i class="fa fa-rss-square"></i>RSS</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/wechat.html" title="订阅 HaHack 的公众平台"><i class="fa fa-qrcode"></i>WeChat</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="http://toutiao.io/u/147640" title=""><i class="fa fa-align-justify"></i>Toutiao</a></li>
				
                	        </ul>
				</li>
				
				<li><a data-pjax href="/about" title="关于我"><i class="fa fa-user"></i>About</a></li>				   				
   					  
            </ul>
            </div> <!-- nav-collapse collapse -->
        </div> <!-- container -->
     </div> <!-- navbar-inner -->
</div> <!-- navbar navbar-inverse -->
</header>
  <div class="container" id="container">
  	<div class="content">
    	 

	
		<div class="page-header">		
			<h1> HTTP Web 服务</h1>
		</div>    
	



<div class="row-fluid wiki">
	<!-- span -->
    
        <div class="span3 toc"></div>
        <div class="span9 note">
    

	

		<!-- content -->
		<p>在Python 3中，可以使用一个第三方的开源库 <a href="http://code.google.com/p/httplib2/" target="_blank" rel="external">httplib2</a> 来处理 HTTP Web 服务。它比自带的模块 http.client 更完整的实现了http协议，同时比另一个自带的模块 urllib.request 提供了更好的抽象。例如：</p>
<ol>
<li>Python的http库不支持缓存，而httplib2支持。</li>
<li>Python的http库不支持最后修改时间检查，而httplib2 支持。</li>
<li>Python的http库不支持ETag，而httplib2支持。</li>
<li>Python的http库不支持压缩，但httplib2支持。</li>
<li>urllib.request模块在从http服务器收到对应的状态码的时候会自动“跟随”重定向, 但它不会告诉你它这么干了。你最后得到了你请求的数据，但是你永远也不会知道下层的库友好的帮助你跟随了重定向；httplib2 帮你处理了永久重定向。它不仅会告诉你发生了永久重定向，而且它会在本地记录这些重定向，并且在发送请求前自动重写为重定向后的url。</li>
</ol>
<p>我们来举个例子，你想要通过http下载一个资源, 比如说一个Atom 供稿。作为一个供稿, 你不会只下载一次，你会一次又一次的下载它。 (大部分的供稿阅读器会美一小时检查一次更新。) 让我们先用最粗糙和最快的方法来实现它，接着再来看看怎样改进。</p>
<h2 id="http-get">HTTP Get</h2>
<p>简单粗暴的方法就是使用 urllib 模块：</p>
<h4 id="示例">示例</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import urllib.request</div><div class="line">&gt;&gt;&gt; a_url = 'http://diveintopython3.org/examples/feed.xml'</div><div class="line">&gt;&gt;&gt; data = urllib.request.urlopen(a_url).read() </div><div class="line">&gt;&gt;&gt; type(data)                                  </div><div class="line">&lt;class 'bytes'&gt;</div><div class="line">&gt;&gt;&gt; print(data)</div><div class="line">&lt;?xml version='1.0' encoding='utf-8'?&gt;</div><div class="line">&lt;feed xmlns='http://www.w3.org/2005/Atom' xml:lang='en'&gt;</div><div class="line">  &lt;title&gt;dive into mark&lt;/title&gt;</div><div class="line">  &lt;subtitle&gt;currently between addictions&lt;/subtitle&gt;</div><div class="line">  &lt;id&gt;tag:diveintomark.org,2001-07-29:/&lt;/id&gt;</div><div class="line">  &lt;updated&gt;2009-03-27T21:56:07Z&lt;/updated&gt;</div><div class="line">  &lt;link rel='alternate' type='text/html' href='http://diveintomark.org/'/&gt;</div><div class="line">  …</div></pre></td></tr></table></figure></p>
<h4 id="说明">说明</h4>
<ul>
<li>在Python中通过http下载东西是非常简单的; 实际上，只需要一行代码。<code>urllib.request</code>模块有一个方便的函数<code>urlopen()</code> ，它接受你所要获取的页面地址，然后返回一个类文件对象，您只要调用它的<code>read()</code>方法就可以获得网页的全部内容。没有比这更简单的了。</li>
<li><code>urlopen().read()</code>方法<strong>总是返回bytes对象，而不是字符串</strong>。记住字节仅仅是字节，字符只是一种抽象。 http 服务器不关心抽象的东西。如果你请求一个资源，你得到字节。 如果你需要一个字符串，你需要确定字符编码，并显式的将其转化成字符串。</li>
</ul>
<p>如果需要定期访问Web服务，上面的做法就显得很低效和粗暴了。充分利用HTTP的缓存、压缩技术将可以实习更高效的做法。于是 <code>httplib2</code> 闪亮登场。</p>
<p>要使用httplib2, 请创建一个 httplib2.Http 类的实例。</p>
<h3 id="创建-httplib2-http-实例">创建 httplib2.Http 实例</h3>
<h4 id="示例-v2">示例</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> httplib2</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>h = httplib2.Http(<span class="string">'.cache'</span>)                                                    </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response, content = h.request(<span class="string">'http://diveintopython3.org/examples/feed.xml'</span>)  </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response.status                                                                </div><div class="line"><span class="number">200</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>content[:<span class="number">52</span>]                                                                   </div><div class="line"><span class="string">b"&lt;?xml version='1.0' encoding='utf-8'?&gt;\r\n&lt;feed xmlns="</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>len(content)</div><div class="line"><span class="number">3070</span></div></pre></td></tr></table></figure></p>
<h4 id="说明-v2">说明</h4>
<ul>
<li>httplib2的主要接口是Http对象。你创建Http对象时总是应该传入一个目录名（例如本例中的<code>.cache</code>），具体原因你会在下一节看见。目录不需要事先存在，httplib2会在必要的时候创建它。</li>
<li>一旦你有了Http对象, 获取数据非常简单，以你要的数据的地址作为参数调用request()方法就可以了。这会对该url执行一个http GET请求. (这一章下面你会看见怎样执行其他http 请求, 比如 POST。)</li>
<li><code>request()</code> 方法返回两个值。第一个是一个<code>httplib2.Response</code>对象，其中包含了服务器返回的所有http头。比如, status为200 表示请求成功。</li>
<li>content 变量包含了http服务器返回的实际数据。数据以bytes对象返回，不是字符串。 如果你需要一个字符串，你需要确定字符编码并自己进行转换。</li>
</ul>
<p><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  <p>你很可能只需要一个httplib2.Http对象。当然存在足够的理由来创建多个，但是只有当你清楚创建多个的原因的时候才应该这样做。从不同的url获取数据不是一个充分的理由，重用Http对象并调用request()方法两次就可以了。</p>
</div></p>
<h3 id="使用缓存">使用缓存</h3>
<p>之后，退出你的Python交互 shell 然后打开一个新的会话：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># NOT continued from previous example!</div><div class="line"># Please exit out of the interactive shell</div><div class="line"># and launch a new one.</div><div class="line">>>> import httplib2</div><div class="line">>>> httplib2.debuglevel = 1                                                        </div><div class="line">>>> h = httplib2.Http('.cache')                                                    </div><div class="line">>>> response, content = h.request('http://diveintopython3.org/examples/feed.xml')  </div><div class="line">>>> len(content)                                                                   </div><div class="line">3070</div><div class="line">>>> response.status                                                                </div><div class="line">200</div><div class="line">>>> response.fromcache                                                             </div><div class="line">True</div></pre></td></tr></table></figure></p>
<h4 id="说明-v3">说明</h4>
<ul>
<li>最后一句话揭示了奥秘所在: 响应是从httplib2的本地缓存构造出来的。你创建httplib2.Http对象是传入的目录里面保存了所有httplib2执行过的操作的缓存。</li>
<li>你刚刚请求过这个url的数据。那个请求是成功的(状态码: 200)。该响应不仅包含feed数据，也包含一系列缓存头，告诉那些关注着的人这个资源可以缓存长达24小时(Cache-Control: max-age=86400, 24小时所对应的秒数)。 httplib2 理解并尊重那些缓存头，并且它会在.cache目录(你在创建Http对象时提供的)保存之前的响应。缓存还没有过期，所以你第二次请求该url的数据时, httplib2不会去访问网络，直接返回缓存着的数据。</li>
</ul>
<p><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  <p>如果你想要打开httplib2的调试开关，你需要设置一个模块级的常量(httplib2.debuglevel), 然后再创建<code>httplib2.Http</code>对象。如果你希望关闭调试，你需要改变同一个模块级常量, 接着创建一个新的<code>httplib2.Http</code>对象。</p>
</div></p>
<h4 id="跳过缓存">跳过缓存</h4>
<p>假设你有数据缓存着，但是你希望跳过缓存并且重新请求远程服务器。由于缓存可能还存留在不受你控制的中继代理服务器里，因此简单删除本地缓存并不足以解决问题。你应该使用http的特性来保证你的请求最终到达远程服务器，而不是修改本地缓存。</p>
<h4 id="示例-v3">示例</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># continued from the previous example</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response2, content2 = h.request(<span class="string">'http://diveintopython3.org/examples/feed.xml'</span>,</div><div class="line"><span class="prompt">... </span>    headers={<span class="string">'cache-control'</span>:<span class="string">'no-cache'</span>})  </div><div class="line">connect: (diveintopython3.org, <span class="number">80</span>)             </div><div class="line">send: <span class="string">b'GET /examples/feed.xml HTTP/1.1</span></div><div class="line">Host: diveintopython3.org</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $</div><div class="line">accept-encoding: deflate, gzip</div><div class="line">cache-control: no-cache'</div><div class="line">reply: <span class="string">'HTTP/1.1 200 OK'</span></div><div class="line">…further debugging information omitted…</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response2.status</div><div class="line"><span class="number">200</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response2.fromcache                        </div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>print(dict(response2.items()))             </div><div class="line">{<span class="string">'status'</span>: <span class="string">'200'</span>,</div><div class="line"> <span class="string">'content-length'</span>: <span class="string">'3070'</span>,</div><div class="line"> <span class="string">'content-location'</span>: <span class="string">'http://diveintopython3.org/examples/feed.xml'</span>,</div><div class="line"> <span class="string">'accept-ranges'</span>: <span class="string">'bytes'</span>,</div><div class="line"> <span class="string">'expires'</span>: <span class="string">'Wed, 03 Jun 2009 00:40:26 GMT'</span>,</div><div class="line"> <span class="string">'vary'</span>: <span class="string">'Accept-Encoding'</span>,</div><div class="line"> <span class="string">'server'</span>: <span class="string">'Apache'</span>,</div><div class="line"> <span class="string">'last-modified'</span>: <span class="string">'Sun, 31 May 2009 22:51:11 GMT'</span>,</div><div class="line"> <span class="string">'connection'</span>: <span class="string">'close'</span>,</div><div class="line"> <span class="string">'-content-encoding'</span>: <span class="string">'gzip'</span>,</div><div class="line"> <span class="string">'etag'</span>: <span class="string">'"bfe-255ef5c0"'</span>,</div><div class="line"> <span class="string">'cache-control'</span>: <span class="string">'max-age=86400'</span>,</div><div class="line"> <span class="string">'date'</span>: <span class="string">'Tue, 02 Jun 2009 00:40:26 GMT'</span>,</div><div class="line"> <span class="string">'content-type'</span>: <span class="string">'application/xml'</span>}</div></pre></td></tr></table></figure></p>
<h4 id="说明-v4">说明</h4>
<p>httplib2 允许你添加任意的http头部到发出的请求里。为了跳过所有缓存(不仅仅是你本地的磁盘缓存，也包括任何处于你和远程服务器之间的缓存代理服务器), 在headers字典里面加入no-cache头就可以了。</p>
<h3 id="处理last-modified和etag头">处理Last-Modified和ETag头</h3>
<p>Cache-Control和Expires缓存头被称为<em>新鲜度指标(freshness indicators)</em>。他们毫不含糊告诉缓存，你可以完全避免所有网络访问，直到缓存过期。而这正是你在前一节所看到的: 给出一个新鲜度指标, httplib2 不会产生哪怕是一个字节的网络活动就可以提供缓存了的数据(当然除非你显式的要求跳过缓存).</p>
<p>那如果数据可能已经改变了, 但实际没有呢? http 为这种目的定义了Last-Modified和Etag头。 这些头被称为验证器(validators)。如果本地缓存已经不是新鲜的，客户端可以在下一个请求的时候发送验证器来检查数据实际上有没有改变。如果数据没有改变，服务器返回304状态码，但不返回数据。 所以虽然还会在网络上有一个来回，但是你最终可以少下载一点字节。</p>
<h4 id="示例代码">示例代码</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> httplib2</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>httplib2.debuglevel = <span class="number">1</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>h = httplib2.Http(<span class="string">'.cache'</span>)</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response, content = h.request(<span class="string">'http://diveintopython3.org/'</span>)  </div><div class="line">connect: (diveintopython3.org, <span class="number">80</span>)</div><div class="line">send: <span class="string">b'GET / HTTP/1.1</span></div><div class="line">Host: diveintopython3.org</div><div class="line">accept-encoding: deflate, gzip</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $'</div><div class="line">reply: <span class="string">'HTTP/1.1 200 OK'</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>print(dict(response.items()))                                 </div><div class="line">{<span class="string">'-content-encoding'</span>: <span class="string">'gzip'</span>,</div><div class="line"> <span class="string">'accept-ranges'</span>: <span class="string">'bytes'</span>,</div><div class="line"> <span class="string">'connection'</span>: <span class="string">'close'</span>,</div><div class="line"> <span class="string">'content-length'</span>: <span class="string">'6657'</span>,</div><div class="line"> <span class="string">'content-location'</span>: <span class="string">'http://diveintopython3.org/'</span>,</div><div class="line"> <span class="string">'content-type'</span>: <span class="string">'text/html'</span>,</div><div class="line"> <span class="string">'date'</span>: <span class="string">'Tue, 02 Jun 2009 03:26:54 GMT'</span>,</div><div class="line"> <span class="string">'etag'</span>: <span class="string">'"7f806d-1a01-9fb97900"'</span>,</div><div class="line"> <span class="string">'last-modified'</span>: <span class="string">'Tue, 02 Jun 2009 02:51:48 GMT'</span>,</div><div class="line"> <span class="string">'server'</span>: <span class="string">'Apache'</span>,</div><div class="line"> <span class="string">'status'</span>: <span class="string">'200'</span>,</div><div class="line"> <span class="string">'vary'</span>: <span class="string">'Accept-Encoding,User-Agent'</span>}</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>len(content)                                                  </div><div class="line"><span class="number">6657</span></div></pre></td></tr></table></figure></p>
<p>现在在此请求同一页面，使用同一个Http对象(以及同一个本地缓存)。httplib2 将ETag validator 通过If-None-Match头发送回服务器。httplib2 也将Last-Modified validator 通过If-Modified-Since头发送回服务器。：</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># continued from the previous example</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response, content = h.request(<span class="string">'http://diveintopython3.org/'</span>)  </div><div class="line">connect: (diveintopython3.org, <span class="number">80</span>)</div><div class="line">send: <span class="string">b'GET / HTTP/1.1</span></div><div class="line">Host: diveintopython3.org</div><div class="line">if-none-match: "7f806d-1a01-9fb97900"                             </div><div class="line">if-modified-since: Tue, 02 Jun 2009 02:51:48 GMT                  </div><div class="line">accept-encoding: deflate, gzip</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $'</div><div class="line">reply: <span class="string">'HTTP/1.1 304 Not Modified'</span>                                </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response.fromcache                                            </div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response.status                                               </div><div class="line"><span class="number">200</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response.dict[<span class="string">'status'</span>]                                       </div><div class="line"><span class="string">'304'</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>len(content)                                                  </div><div class="line"><span class="number">6657</span></div></pre></td></tr></table></figure></p>
<p>服务器查看这些验证器(validators), 查看你请求的页面，然后判读得出页面在上次请求之后没有改变过, 所以它发回了304 状态码不带数据。</p>
<h3 id="处理压缩">处理压缩</h3>
<p>http支持两种类型的压缩。httplib2都支持。</p>
<h4 id="示例-v4">示例</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response, content = h.request(<span class="string">'http://diveintopython3.org/'</span>)</div><div class="line">connect: (diveintopython3.org, <span class="number">80</span>)</div><div class="line">send: <span class="string">b'GET / HTTP/1.1</span></div><div class="line">Host: diveintopython3.org</div><div class="line">accept-encoding: deflate, gzip                          </div><div class="line">user-agent: Python-httplib2/$Rev: 259 $'</div><div class="line">reply: <span class="string">'HTTP/1.1 200 OK'</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>print(dict(response.items()))</div><div class="line">{<span class="string">'-content-encoding'</span>: <span class="string">'gzip'</span>,                           </div><div class="line"> <span class="string">'accept-ranges'</span>: <span class="string">'bytes'</span>,</div><div class="line"> <span class="string">'connection'</span>: <span class="string">'close'</span>,</div><div class="line"> <span class="string">'content-length'</span>: <span class="string">'6657'</span>,</div><div class="line"> <span class="string">'content-location'</span>: <span class="string">'http://diveintopython3.org/'</span>,</div><div class="line"> <span class="string">'content-type'</span>: <span class="string">'text/html'</span>,</div><div class="line"> <span class="string">'date'</span>: <span class="string">'Tue, 02 Jun 2009 03:26:54 GMT'</span>,</div><div class="line"> <span class="string">'etag'</span>: <span class="string">'"7f806d-1a01-9fb97900"'</span>,</div><div class="line"> <span class="string">'last-modified'</span>: <span class="string">'Tue, 02 Jun 2009 02:51:48 GMT'</span>,</div><div class="line"> <span class="string">'server'</span>: <span class="string">'Apache'</span>,</div><div class="line"> <span class="string">'status'</span>: <span class="string">'304'</span>,</div><div class="line"> <span class="string">'vary'</span>: <span class="string">'Accept-Encoding,User-Agent'</span>}</div></pre></td></tr></table></figure></p>
<h4 id="说明-v5">说明</h4>
<ul>
<li>每一次httplib2 发送请求，它包含了Accept-Encoding头来告诉服务器它能够处理deflate 或者 gzip压缩。</li>
<li>这个例子中，服务器返回了gzip压缩过的负载，当<code>request()</code>方法返回的时候，httplib2就已经解压缩了响应的体(body)并将其放在 content变量里。如果你想知道响应是否压缩过, 你可以检查<code>response['-content-encoding']</code>；否则，不用担心了.</li>
</ul>
<h3 id="处理重定向">处理重定向</h3>
<p>http 定义了 两种类型的重定向: 临时的和永久的。</p>
<h4 id="临时重定向">临时重定向</h4>
<p>对于临时重定向，除了跟随它们其他没有什么特别要做的, httplib2 会自动处理跟随。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> httplib2</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>httplib2.debuglevel = <span class="number">1</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>h = httplib2.Http(<span class="string">'.cache'</span>)</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response, content = h.request(<span class="string">'http://diveintopython3.org/examples/feed-302.xml'</span>) </div><div class="line">connect: (diveintopython3.org, <span class="number">80</span>)</div><div class="line">send: <span class="string">b'GET /examples/feed-302.xml HTTP/1.1                                           </span></div><div class="line">Host: diveintopython3.org</div><div class="line">accept-encoding: deflate, gzip</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $'</div><div class="line">reply: <span class="string">'HTTP/1.1 302 Found'</span>                                                           </div><div class="line">send: <span class="string">b'GET /examples/feed.xml HTTP/1.1    # 跟随重定向                                </span></div><div class="line">Host: diveintopython3.org</div><div class="line">accept-encoding: deflate, gzip</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $'</div><div class="line">reply: <span class="string">'HTTP/1.1 200 OK'</span></div></pre></td></tr></table></figure></p>
<p>“跟随” 一个重定向就是这个例子展示的那么多。httplib2 发送一个请求到你要求的url。服务器返回一个响应说“不，不, 看那边.” httplib2 给新的url发送另一个请求.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># continued from the previous example</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response                                                          </div><div class="line">{<span class="string">'status'</span>: <span class="string">'200'</span>,</div><div class="line"> <span class="string">'content-length'</span>: <span class="string">'3070'</span>,</div><div class="line"> <span class="string">'content-location'</span>: <span class="string">'http://diveintopython3.org/examples/feed.xml'</span>,  </div><div class="line"> <span class="string">'accept-ranges'</span>: <span class="string">'bytes'</span>,</div><div class="line"> <span class="string">'expires'</span>: <span class="string">'Thu, 04 Jun 2009 02:21:41 GMT'</span>,</div><div class="line"> <span class="string">'vary'</span>: <span class="string">'Accept-Encoding'</span>,</div><div class="line"> <span class="string">'server'</span>: <span class="string">'Apache'</span>,</div><div class="line"> <span class="string">'last-modified'</span>: <span class="string">'Wed, 03 Jun 2009 02:20:15 GMT'</span>,</div><div class="line"> <span class="string">'connection'</span>: <span class="string">'close'</span>,</div><div class="line"> <span class="string">'-content-encoding'</span>: <span class="string">'gzip'</span>,                                         </div><div class="line"> <span class="string">'etag'</span>: <span class="string">'"bfe-4cbbf5c0"'</span>,</div><div class="line"> <span class="string">'cache-control'</span>: <span class="string">'max-age=86400'</span>,                                    </div><div class="line"> <span class="string">'date'</span>: <span class="string">'Wed, 03 Jun 2009 02:21:41 GMT'</span>,</div><div class="line"> <span class="string">'content-type'</span>: <span class="string">'application/xml'</span>}</div></pre></td></tr></table></figure></p>
<p>注意，你调用<code>request()</code>方法返回的<code>response</code>是<strong>最终url</strong>的响应。httplib2 会将最终的 url（在这里是feed.xml而不是上面的fee2.xml的url） 以 <code>content-location</code> 加入到 <code>response</code> 字典中。这不是服务器返回的头，它特定于httplib2。</p>
<p>如果你希望那些最后重定向到最终url的中间url的信息呢？httplib2 也能帮你。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># continued from the previous example</div><div class="line">&gt;&gt;&gt; response.previous                                                     </div><div class="line">{'status': '302',</div><div class="line"> 'content-length': '228',</div><div class="line"> 'content-location': 'http://diveintopython3.org/examples/feed-302.xml',</div><div class="line"> 'expires': 'Thu, 04 Jun 2009 02:21:41 GMT',</div><div class="line"> 'server': 'Apache',</div><div class="line"> 'connection': 'close',</div><div class="line"> 'location': 'http://diveintopython3.org/examples/feed.xml',</div><div class="line"> 'cache-control': 'max-age=86400',</div><div class="line"> 'date': 'Wed, 03 Jun 2009 02:21:41 GMT',</div><div class="line"> 'content-type': 'text/html; charset=iso-8859-1'}</div><div class="line">&gt;&gt;&gt; type(response)                                                        </div><div class="line">&lt;class 'httplib2.Response'&gt;</div><div class="line">&gt;&gt;&gt; type(response.previous)</div><div class="line">&lt;class 'httplib2.Response'&gt;</div><div class="line">&gt;&gt;&gt; response.previous.previous                                            </div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure></p>
<p><code>response.previous</code>属性持有前一个响应对象的引用，httplib2跟随那个响应获得了当前的响应对象。<code>response</code> 和 <code>response.previous</code> 都是 <code>httplib2.Response</code> 对象。这意味着你可以通过<code>response.previous.previous</code> 来反向跟踪重定向链到更前的请求。</p>
<p><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  <p>对于临时重定向你不需要做什么特别的处理。httplib2 会自动跟随它们，而一个url重定向到另一个这个事实上不会影响httplib2对压缩，缓存, ETags, 或者任何其他http特性的支持。</p>
</div></p>
<h4 id="永久重定向">永久重定向</h4>
<p>永久重定向同样也很简单。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># continued from the previous example</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response, content = h.request(<span class="string">'http://diveintopython3.org/examples/feed-301.xml'</span>)  </div><div class="line">connect: (diveintopython3.org, <span class="number">80</span>)</div><div class="line">send: <span class="string">b'GET /examples/feed-301.xml HTTP/1.1</span></div><div class="line">Host: diveintopython3.org</div><div class="line">accept-encoding: deflate, gzip</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $'</div><div class="line">reply: <span class="string">'HTTP/1.1 301 Moved Permanently'</span>                                                </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response.fromcache                                                                 </div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<ul>
<li>又一次，这个url实际上并不存在。服务器已将其永久重定向到<code>http://diveintopython3.org/examples/feed.xml</code>.</li>
<li>这就是: 状态码 301。 但是再次注意什么没有发生: 没有发送到重定向后的url的请求。为什么没有? 因为它已经在本地缓存了。</li>
<li>httplib2 “跟随” 重定向到了它的缓存里面。</li>
</ul>
<p>但是等等! 还有更多!</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># continued from the previous example</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response2, content2 = h.request(<span class="string">'http://diveintopython3.org/examples/feed-301.xml'</span>)  </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>response2.fromcache                                                                  </div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>content2 == content                                                                  </div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>这是临时和永久重定向的区别: 一旦 httplib2跟随了一个永久重定向, 所有后续的对这个url的请求会被透明的重写到目标 url 而不会接触网络来访问原始的url。 记住, 调试还开着, 但没有任何网络活动的输出。</p>
<h2 id="http-post">HTTP Post</h2>
<p>当你在论坛上发表一个评论，更新你的博客，在 Twitter 或者 <a href="http://Identi.ca" target="_blank" rel="external">Identi.ca</a> 这样的微博客上面发表状态消息的时候, 你很可能已经使用了http POST。</p>
<p>Twitter 和 <a href="http://Identi.ca" target="_blank" rel="external">Identi.ca</a> 都提供一个基于http的简单的api来发布并更新你状态(不超过140个字符)。让我们来看看Identi.ca的关于更新状态的api文档 :</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Identi.ca 的rest api 方法: statuses/update</div><div class="line">更新已认证用户的状态。需要下面格式的status参数。请求必须是POST.</div><div class="line"></div><div class="line">url</div><div class="line">https://identi.ca/api/statuses/update.format</div><div class="line">Formats</div><div class="line">xml, json, rss, atom</div><div class="line">http Method(s)</div><div class="line">POST</div><div class="line">Requires Authentication</div><div class="line">true</div><div class="line">Parameters</div><div class="line">status. Required. The text of your status update. url-encode as necessary.</div></pre></td></tr></table></figure></p>
<p>怎么操作呢？要在 <a href="http://Identi.ca" target="_blank" rel="external">Identi.ca</a> 发布一条消息, 你需要提交一个http POST请求到<code>http://identi.ca/api/statuses/update.format</code>。(format字样不是url的一部分; 你应该将其替换为你希望服务器返回的请求的格式。所以如果需要一个xml格式的返回。你应该向<code>https://identi.ca/api/statuses/update.xml发送请求。</code>) 请求需要一个参数status, 包含了你的状态更新文本。并且请求必须是已授权的。<a href="http://Identi.ca" target="_blank" rel="external">Identi.ca</a> 使用建立在ssl之上的<a href="http://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank" rel="external">HTTP Basic Authentication</a> (也就是<a href="http://www.ietf.org/rfc/rfc2617.txt" target="_blank" rel="external">RFC 2617</a>) 来提供安全但方便的认证。httplib2 支持 ssl 和 http Basic Authentication, 所以这部分很简单。</p>
<p>POST 请求同 GET 请求不同, 因为它包含负荷(payload)。负荷是你要发送到服务器的数据。这个api方法必须的参数是status, 并且它应该是<strong>url编码过的</strong>。 这是一种很简单的序列化格式，将一组键值对(比如字典)转化为一个字符串。Python 带有一个工具函数用于url编码一个字典: <code>urllib.parse.urlencode()</code>。</p>
<h4 id="示例-v5">示例</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> httplib2</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>httplib2.debuglevel = <span class="number">1</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>h = httplib2.Http(<span class="string">'.cache'</span>)</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>data = {<span class="string">'status'</span>: <span class="string">'Test update from Python 3'</span>} </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>h.add_credentials(<span class="string">'diveintomark'</span>, <span class="string">'MY_SECRET_PASSWORD'</span>, <span class="string">'identi.ca'</span>)    </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>resp, content = h.request(<span class="string">'https://identi.ca/api/statuses/update.xml'</span>,</div><div class="line"><span class="prompt">... </span>    <span class="string">'POST'</span>,                                                             </div><div class="line"><span class="prompt">... </span>    urlencode(data),                                                    </div><div class="line"><span class="prompt">... </span>    headers={<span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>})</div></pre></td></tr></table></figure></p>
<h4 id="说明-v6">说明</h4>
<ul>
<li>第5行是 <a href="http://Identi.ca" target="_blank" rel="external">Identi.ca</a> api 所期望的字典。</li>
<li>第6行是httplib2处理认证的方法。 <code>add_credentials()</code>方法记录你的用户名和密码。当 httplib2 试图执行请求的时候，服务器会返回一个401 Unauthorized状态码, 并且列出所有它支持的认证方法(在 WWW-Authenticate 头中). httplib2会自动构造Authorization头并且重新请求该url。</li>
<li>第二个参数是http请求的类型。这里是POST。</li>
<li>第三个参数是要发送到服务器的负荷 。我们发送包含状态消息的url编码过的字典。</li>
<li>最后，我们得告诉服务器负荷是url编码过的数据。</li>
</ul>
<p><div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  <p><code>add_credentials()</code>方法的第三个参数是该证书有效的域名。你应该总是指定这个参数! 如果你省略了这个参数，并且之后重用这个httplib2.Http对象访问另一个需要认证的站点，可能会导致httplib2将一个站点的用户名密码泄漏给其他站点。</p>
</div></p>
<h4 id="发送到线路上的数据">发送到线路上的数据</h4>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># continued from the previous example</div><div class="line">send: b'POST /api/statuses/update.xml HTTP/1.1</div><div class="line">Host: identi.ca</div><div class="line">Accept-Encoding: identity</div><div class="line">Content-Length: 32</div><div class="line">content-type: application/x-www-form-urlencoded</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $</div><div class="line"></div><div class="line">status=Test+update+from+Python+3'</div><div class="line">reply: 'HTTP/1.1 401 Unauthorized'                        </div><div class="line">send: b'POST /api/statuses/update.xml HTTP/1.1            </div><div class="line">Host: identi.ca</div><div class="line">Accept-Encoding: identity</div><div class="line">Content-Length: 32</div><div class="line">content-type: application/x-www-form-urlencoded</div><div class="line">authorization: Basic SECRET_HASH_CONSTRUCTED_BY_HTTPLIB2  </div><div class="line">user-agent: Python-httplib2/$Rev: 259 $</div><div class="line"></div><div class="line">status=Test+update+from+Python+3'</div><div class="line">reply: 'HTTP/1.1 200 OK'</div></pre></td></tr></table></figure></p>
<h4 id="服务器返回客户端的数据">服务器返回客户端的数据</h4>
<p>请求成功后服务器返回什么？这个完全由web 服务 api决定。 在一些协议里面(就像 <a href="http://www.ietf.org/rfc/rfc5023.txt" target="_blank" rel="external">Atom Publishing Protocol</a> )，服务器会返回201 Created状态码，并通过Location提供新创建的资源的地址。<a href="http://Identi.ca" target="_blank" rel="external">Identi.ca</a> 返回<code>200 OK</code>和一个包含新创建资源信息的xml 文档。</p>
<p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"># continued from the previous example</div><div class="line">&gt;&gt;&gt; print(content.decode('utf-8'))                             </div><div class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">status</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">text</span>&gt;</span>Test update from Python 3<span class="tag">&lt;/<span class="title">text</span>&gt;</span>                        </div><div class="line"> <span class="tag">&lt;<span class="title">truncated</span>&gt;</span>false<span class="tag">&lt;/<span class="title">truncated</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">created_at</span>&gt;</span>Wed Jun 10 03:53:46 +0000 2009<span class="tag">&lt;/<span class="title">created_at</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">in_reply_to_status_id</span>&gt;</span><span class="tag">&lt;/<span class="title">in_reply_to_status_id</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">source</span>&gt;</span>api<span class="tag">&lt;/<span class="title">source</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">id</span>&gt;</span>5131472<span class="tag">&lt;/<span class="title">id</span>&gt;</span>                                              </div><div class="line"> <span class="tag">&lt;<span class="title">in_reply_to_user_id</span>&gt;</span><span class="tag">&lt;/<span class="title">in_reply_to_user_id</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">in_reply_to_screen_name</span>&gt;</span><span class="tag">&lt;/<span class="title">in_reply_to_screen_name</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">favorited</span>&gt;</span>false<span class="tag">&lt;/<span class="title">favorited</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="title">user</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">id</span>&gt;</span>3212<span class="tag">&lt;/<span class="title">id</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">name</span>&gt;</span>Mark Pilgrim<span class="tag">&lt;/<span class="title">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">screen_name</span>&gt;</span>diveintomark<span class="tag">&lt;/<span class="title">screen_name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">location</span>&gt;</span>27502, US<span class="tag">&lt;/<span class="title">location</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">description</span>&gt;</span>tech writer, husband, father<span class="tag">&lt;/<span class="title">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_image_url</span>&gt;</span>http://avatar.identi.ca/3212-48-20081216000626.png<span class="tag">&lt;/<span class="title">profile_image_url</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">url</span>&gt;</span>http://diveintomark.org/<span class="tag">&lt;/<span class="title">url</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">protected</span>&gt;</span>false<span class="tag">&lt;/<span class="title">protected</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">followers_count</span>&gt;</span>329<span class="tag">&lt;/<span class="title">followers_count</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_background_color</span>&gt;</span><span class="tag">&lt;/<span class="title">profile_background_color</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_text_color</span>&gt;</span><span class="tag">&lt;/<span class="title">profile_text_color</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_link_color</span>&gt;</span><span class="tag">&lt;/<span class="title">profile_link_color</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_sidebar_fill_color</span>&gt;</span><span class="tag">&lt;/<span class="title">profile_sidebar_fill_color</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_sidebar_border_color</span>&gt;</span><span class="tag">&lt;/<span class="title">profile_sidebar_border_color</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">friends_count</span>&gt;</span>2<span class="tag">&lt;/<span class="title">friends_count</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">created_at</span>&gt;</span>Wed Jul 02 22:03:58 +0000 2008<span class="tag">&lt;/<span class="title">created_at</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">favourites_count</span>&gt;</span>30768<span class="tag">&lt;/<span class="title">favourites_count</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">utc_offset</span>&gt;</span>0<span class="tag">&lt;/<span class="title">utc_offset</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">time_zone</span>&gt;</span>UTC<span class="tag">&lt;/<span class="title">time_zone</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_background_image_url</span>&gt;</span><span class="tag">&lt;/<span class="title">profile_background_image_url</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">profile_background_tile</span>&gt;</span>false<span class="tag">&lt;/<span class="title">profile_background_tile</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">statuses_count</span>&gt;</span>122<span class="tag">&lt;/<span class="title">statuses_count</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">following</span>&gt;</span>false<span class="tag">&lt;/<span class="title">following</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="title">notifications</span>&gt;</span>false<span class="tag">&lt;/<span class="title">notifications</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">user</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">status</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>记住, <strong>httplib2返回的数据总是字节串(bytes), 不是字符串</strong>。另外，上面第10行是这条状态消息的唯一标识符。<a href="http://Identi.ca" target="_blank" rel="external">Identi.ca</a> 用这个标识来构造在web上查看该消息的url。</p>
<h2 id="http-delete">HTTP DELETE</h2>
<p>http 并不只限于 GET 和 POST。 它们当然是最常见的请求类型，特别是在web浏览器里面。 但是web服务api会使用GET和POST之外的东西, 对此httplib2也能处理。</p>
<h4 id="示例-v6">示例</h4>
<p>下面将示例如何执行 HTTP DELETE 删除一条状态消息。要删除一条状态消息，首先需要找到该状态消息的 id。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># continued from the previous example</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> xml.etree <span class="keyword">import</span> ElementTree <span class="keyword">as</span> etree</div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>tree = etree.fromstring(content)                                          </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>status_id = tree.findtext(<span class="string">'id'</span>)                                           </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>status_id</div><div class="line"><span class="string">'5131472'</span></div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>url = <span class="string">'https://identi.ca/api/statuses/destroy/{0}.xml'</span>.format(status_id)  </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>resp, deleted_content = h.request(url, <span class="string">'DELETE'</span>)</div></pre></td></tr></table></figure></p>
<p>之后对该url执行一个http DELETE请求就可以了。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">send: <span class="string">b'DELETE /api/statuses/destroy/5131472.xml HTTP/1.1      </span></div><div class="line">Host: identi.ca</div><div class="line">Accept-Encoding: identity</div><div class="line">user-agent: Python-httplib2/$Rev: 259 $</div><div class="line"></div><div class="line">'</div><div class="line">reply: <span class="string">'HTTP/1.1 401 Unauthorized'</span>                             </div><div class="line">send: <span class="string">b'DELETE /api/statuses/destroy/5131472.xml HTTP/1.1      </span></div><div class="line">Host: identi.ca</div><div class="line">Accept-Encoding: identity</div><div class="line">authorization: Basic SECRET_HASH_CONSTRUCTED_BY_HTTPLIB2       </div><div class="line">user-agent: Python-httplib2/$Rev: 259 $</div><div class="line"></div><div class="line">'</div><div class="line">reply: <span class="string">'HTTP/1.1 200 OK'</span>                                       </div><div class="line"><span class="prompt">&gt;&gt;&gt; </span>resp.status</div><div class="line"><span class="number">200</span></div></pre></td></tr></table></figure></p>
<h2 id="进一步阅读">进一步阅读</h2>
<h3 id="httplib2">httplib2</h3>
<ul>
<li><a href="http://code.google.com/p/httplib2/" target="_blank" rel="external">httplib2项目页面</a></li>
<li><a href="http://code.google.com/p/httplib2/wiki/ExamplesPython3" target="_blank" rel="external">更多httplib2的代码示例</a></li>
<li><a href="http://www.xml.com/pub/a/2006/02/01/doing-http-caching-right-introducing-httplib2.html" target="_blank" rel="external">正确的处理http缓存: 介绍httplib2</a></li>
<li><a href="http://www.xml.com/pub/a/2006/03/29/httplib2-http-persistence-and-authentication.html" target="_blank" rel="external">httplib2: http 持久化和认证</a></li>
</ul>
<h3 id="http-缓存">http 缓存</h3>
<ul>
<li><a href="http://www.mnot.net/cache_docs/" target="_blank" rel="external">http 缓存教程</a></li>
<li><a href="http://code.google.com/p/doctype/wiki/ArticleHttpCaching" target="_blank" rel="external">怎用使用http头控制缓存</a></li>
</ul>
<h3 id="rfcs">RFCS</h3>
<ul>
<li><a href="http://www.ietf.org/rfc/rfc2616.txt" target="_blank" rel="external">RFC 2616: HTTP</a></li>
<li><a href="http://www.ietf.org/rfc/rfc2617.txt" target="_blank" rel="external">RFC 2617: HTTP Basic Authentication</a></li>
<li><a href="http://www.ietf.org/rfc/rfc1951.txt" target="_blank" rel="external">RFC 1951: deflate compression</a></li>
<li><a href="http://www.ietf.org/rfc/rfc1952.txt" target="_blank" rel="external">RFC 1952: gzip compression</a></li>
<li><a href="http://www.rfc-editor.org/rfc-index2.html" target="_blank" rel="external">RFC Index</a></li>
</ul>


		<!-- pagination -->
		<div>
		<center>
		<div class="pagination">
<ul class="pagination">
	
	
	
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
			
			
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
	
	    
			
			
		
	
	    
	
	    
	
	    
			
			
			
	    
	
	    
	
	    
			
		
	
	    
	
	    
			
		
	
	    
	
	    
			
		
	
	    
	
	    
			
		
	
	    
	
	    
	
	    
	
	    
	
	
		<li class="prev"><a data-pjax href="/wiki/python3-packaging.html" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
	
	<li><a data-pjax href="/wiki"><i class="fa fa-tasks"></i>Wiki</a></li>
	
		<li class="next"><a data-pjax href="/wiki/python3-xml.html" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>
	
</ul>
</div>

	    </center>
		</div>
				
		<!-- toc -->
		
   	<script type="text/javascript">
		jQuery(document).ready(function() {
		
 		   generateWikiTOC('.note', '.toc', 2, 2 );
		
		});
	</script>



				
		<!-- comment -->
		
<section id="comment">
    <h2 class="title">Comments</h2>
	
	 <div id="comment-thread"></div>
	 <div id="loading-spin"></div>
	 <script type="text/javascript">
	   getComments({
		       type: "github",
	           user: "wzpan",
	           repo: "wzpan.github.io",
			   client_id: "1eb35434de75c06a513f",
			   client_secret: "6e4193f8ecd619cdfac2b1aa16b3663fe18d2e90",
			   no_comment: "暂时还没有留言呢，点击下面的按钮去留言吧！",
			   go_to_comment: "去留言",
			   btn_class: "btn btn-primary",
			   no_issue: "no_issue",
			   issue_title: "HTTP Web 服务",
			   issue_id: "undefined",
			   comments_target: "#comment-thread" ? "#comment-thread" : "#comment-thread",
			   loading_target: "undefined"
			   });
	 </script>
	
</section>


		

	</div> <!-- span9/span12 -->
</div><!-- row-fluid post-full -->

	</div>	
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 Joseph Pan
  
    <small>
     <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="/images/license.png"></a>
    </small>
</p>
 </footer>
</div> <!-- container-narrow -->


<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/dist/jquery.imagesloaded.min.js"></script>


<script src="/dist/gallery.min.js"></script>
<script src="/dist/bootstrap.min.js"></script>
<script src="/dist/jquery.tableofcontents.min.js"></script>
<script src="/dist/tocgenerator.min.js"></script>
<script src="/dist/require.min.js"></script>
<script src="/dist/main.min.js"></script>



<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox({
    helpers : { 
        title : { type : 'inside' }
    },
    afterLoad : function() {
        this.title = (this.title ? '' + this.title + '<br />' : '') + 'Image ' + (this.index + 1) + ' of ' + this.group.length;
    }
  });
})(jQuery);
</script>




<!-- syntax highlighting -->

  <script>
  marked.setOptions({
    highlight: function (code, lang) {
        return hljs.highlightAuto(code).value;
    }
  });
  function Highlighting(){
    var markdowns = document.getElementsByClassName('markdown');
    for(var i=0;i<markdowns.length;i++){
        if(markdowns[i].innerHTML) markdowns[i].innerHTML =marked(markdowns[i].innerHTML);
    }
  }
  window.addEventListener('DOMContentLoaded', Highlighting, false);
  window.addEventListener('load', Highlighting, false);
  </script>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

  _st('install','ney3Rb77vMaWT2KUKFyt');
</script>



</body>
</html>
