<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>化繁为简的企业级 Git 管理实践（一）：多分支子模块依赖管理 | HaHack</title>
  <meta name="author" content="Joseph Pan">
  
  <meta name="description" content="介绍面向复杂工程的简单化 Git 分支依赖管理方案。我们对子模块的使用进行了简化，避免了由于漏提交子模块 commit id 或子模块代码导致无法更新或更新错误的情况。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="化繁为简的企业级 Git 管理实践（一）：多分支子模块依赖管理"/>
  <meta property="og:site_name" content="HaHack"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/images/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="HaHack" type="application/atom+xml">
  
  <link rel="stylesheet" href="/dist/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bootstrap-responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/font-awesome.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/style.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/highlight.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/sidenav.min.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/dist/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bubble.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/google-fonts.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/nprogress.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/comment.min.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<!--  -->
<!--     <link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow|PT+Sans:400,400italic,700,700italic|Droid+Serif:400,400italic' rel='stylesheet' type='text/css'> -->
<!--     <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'> -->
<!--  -->
  
<script src="/dist/jquery-2.0.3.min.js"></script>


    <script src="/dist/videoGFW.min.js"></script>
	
	


    <script src="/dist/comment.js"></script>
    <script src="/dist/markdown.min.js"></script>
    <script src="/dist/timeago.min.js"></script>
	<script src="/dist/spin.min.js"></script>


</head>


<body data-spy="scroll" data-target=".toc">  
  <header id="header" class="inner"><div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
            <a data-pjax class="brand" href="/">HaHack</a>
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="nav-collapse collapse">
            <ul class="nav">				
			    
				   <li><a data-pjax href="/archive" title="所有文章归档"><i class="fa fa-archive"></i>Archive</a></li>				   			    			
				   <li><a data-pjax href="/categories" title="所有文章分类"><i class="fa fa-folder"></i>Categories</a></li>				   			    			
				   <li><a data-pjax href="/tags" title="所有文章标签"><i class="fa fa-tags"></i>Tags</a></li>				   			    			
				
				<li class="divider-vertical"></li>
			   	<li><a data-pjax href="/wiki" title="我的笔记库"><i class="fa fa-tasks"></i>wiki</a></li>				   
				
            </ul>			
			<ul class="nav navright">
				<li class="dropdown">
				<a data-pjax href="#" title="订阅本站" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-rss"></i>Subscribe <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/atom.xml" title="使用 RSS 阅读器订阅 HaHack"><i class="fa fa-rss-square"></i>RSS</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/wechat.html" title="订阅 HaHack 的公众平台"><i class="fa fa-qrcode"></i>WeChat</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="http://toutiao.io/u/147640" title=""><i class="fa fa-align-justify"></i>Toutiao</a></li>
				
                	        </ul>
				</li>
				
				<li><a data-pjax href="/about" title="关于我"><i class="fa fa-user"></i>About</a></li>				   				
   					  
            </ul>
            </div> <!-- nav-collapse collapse -->
        </div> <!-- container -->
     </div> <!-- navbar-inner -->
</div> <!-- navbar navbar-inverse -->
</header>
  <div class="container" id="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> 化繁为简的企业级 Git 管理实践（一）：多分支子模块依赖管理</h1>
		</div>    
	





<div class="row-fluid post">
	<!-- span -->
	
	<div class="span9">
	

	<!-- <div class="alert alert-error">
	<button type="button" class="close" data-dismiss="alert">&times;</button>
	<i class="fa fa-gift"></i> 过年了，<a href="/donate.html" target="_blank">给HaHack派个红包吧</a>！
</div> -->

	
		<div class="alert alert-success">
			<i class="fa fa-info-circle"></i> <p>介绍面向复杂工程的简单化 Git 分支依赖管理方案。我们对子模块的使用进行了简化，避免了由于漏提交子模块 commit id 或子模块代码导致无法更新或更新错误的情况。</p>

		</div> <!-- alert -->
	
		   

		<!-- content -->
		<div class="mypage">
		<h2 id="需求描述">需求描述</h2>
<p>我们尝试使用 Git 来维护一个项目的代码。这个项目的结构比较复杂：</p>
<ul>
<li>项目包含由多个子模块，每个子模块是一个独立的 Git 仓库，子模块还允许继续嵌套包含子模块。 例如，主工程依赖 common、framework、react_native 等多个子模块，而 react_native 子模块又依赖 node_modules、HFCommon、HFModules 等多个嵌套子模块。</li>
</ul>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[-] app_android/</div><div class="line"> |-[+] HFUIKit</div><div class="line"> |-[+] channel</div><div class="line"> |-[+] common</div><div class="line"> |-[+] framework</div><div class="line"> |-[+] hybrid</div><div class="line"> |-[+] messagecenter</div><div class="line"> |-[-] react_native</div><div class="line">    |-[+] HFCommon</div><div class="line">    |-[+] HFModules</div><div class="line">    |-[+] node_modules</div></pre></td></tr></table></figure></p>
<ul>
<li>主工程和子模块允许存在多个分支，且相互之间有依赖关系。例如，主工程的 jilin 分支同时依赖 common 子模块的 master 分支，以及 framework 子模块的 jilin 分支。</li>
</ul>
<a id="more"></a>
<h2 id="git-submodule-的问题">Git submodule 的问题</h2>
<p>Git 提供了 submodule 来支持子模块的需求，使用它可以很方便的将多个独立仓库包含到同一个主工程中：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git init</div><div class="line">$ git submodule add http://xxx.xxx/common.git</div><div class="line">$ git submodule add http://xxx.xxx/framework.git</div></pre></td></tr></table></figure></p>
<p>Git submodule 还支持嵌套添加子模块：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ git submodule add http://xxx.xxx/react_native.git</div><div class="line">$ <span class="built_in">cd</span> react_native</div><div class="line">$ git submodule add http://xxx.xxx/HFCommon.git</div><div class="line">$ git submodule add http://xxx.xxx/HFModules.git</div><div class="line">$ git submodule add http://xxx.xxx/node_modules.git</div></pre></td></tr></table></figure></p>
<p>通过子模块，这些子模块既可以各自独立的修改和提交代码，又可以将改动作用到依赖它的父工程。这听起来是个很棒的特性，然而 Git submodule 也存在着一些让人抓狂的坑。</p>
<p>首先，主工程并不直接跟踪子模块的代码，而仅仅只跟踪子模块的 commit id 的改动。在执行 <code>git submodule update</code> 更新子模块代码时，Git 就是根据主工程所维护的 commit id 来更新子模块到指定状态的。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">bash-<span class="number">3.2</span>$ git diff react_native </div><div class="line">diff --git a/react_native b/react_native</div><div class="line">index <span class="number">3</span>a9c5b1..ad68a28 <span class="number">160000</span></div><div class="line">--- a/react_native</div><div class="line">+++ b/react_native</div><div class="line">@@ -<span class="number">1</span> +<span class="number">1</span> @@</div><div class="line">-Subproject commit <span class="number">3</span>a9c5b14c45b199e2e6863d2b6da22dabc2a54f5</div><div class="line">+Subproject commit ad68a28c13d4196df531c7df8523d07358288297</div><div class="line">(END)</div></pre></td></tr></table></figure></p>
<p>因此，如果你只在子模块中修改并提交了代码，而没有到主工程上面再把子模块的 commit id 提交一下，其他人拉取工程代码的时候会发现子模块的代码依然停留在老的 commit id 所指向的状态。对于嵌套子模块，这种工作尤为繁琐，提交代码后要逐层往上提交 commit id ，否则其他人无法正确更新代码。</p>
<p>其次，如前面所说，使用 <code>git submodule update</code> 更新子模块后，子模块将被切换到一个指向父工程维护的 commit id 所指定的游离状态：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">bash-<span class="number">3.2</span>$ git submodule update react_native</div><div class="line">bash-<span class="number">3.2</span>$ <span class="built_in">cd</span> react_native</div><div class="line">bash-<span class="number">3.2</span>$ git branch</div><div class="line">* (detached from <span class="number">3</span>a9c5b1)</div><div class="line">  master</div><div class="line">  jilin</div><div class="line">  TaiShan</div></pre></td></tr></table></figure></p>
<p>一旦代码处于游离分支，你就要时刻警惕在游离分支上的提交有没有即时合并到非游离分支上。如果你直接在游离分支上开发并提交了代码，之后在父工程里再次 <code>git submodule update</code> ，你所有未合并的提交都会丢失！</p>
<p>最后还有一个非常麻烦，但也极容易出现的问题：如果团队里有人只提交了主工程该子模块的 commit id ，却忘了进入该模块提交模块真正的代码，那么当推送到中央仓库之后，其他人就会因为找不到与该 commit id 对应的代码而无法正确更新代码：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">bash-<span class="number">3.2</span>$ git submodule update</div><div class="line">error: pathspec <span class="string">'ad68a28c13d4196df531c7df8523d07358288297'</span> did not match any file(s) known to git.</div><div class="line">Did you forget to <span class="string">'git add'</span>?</div><div class="line">Unable to checkout <span class="string">'ad68a28c13d4196df531c7df8523d07358288297'</span> <span class="keyword">in</span> submodule path <span class="string">'react_native'</span></div></pre></td></tr></table></figure></p>
<p>对于熟练的用户，这些坑自然可以轻松越过。但考虑到团队里大都是 Git 新手，我们发现子模块的引入对他们造成了很大的负担，频繁出现子模块代码没有更新到最新状态，或者更新出错的情况。</p>
<h2 id="简单解决方案">简单解决方案</h2>
<p>经过考虑，我们决定对子模块的使用做些简化：</p>
<ol>
<li>所有子模块不再根据父工程的 commit id 更新代码，而是直接更新到主工程所依赖的分支的最新一次提交；</li>
<li>由于 commit id 不再用来更新代码，因此可以禁止直接提交子模块的 commit id ，避免出现只提交子模块 commit id 而忘记提交子模块代码的情况。</li>
</ol>
<h3 id="造个轮子：fmanager">造个轮子：fmanager</h3>
<p>为了达到第一个目的，我们自己写了个专用的管理工具 fmanager 。目前它一共支持如下几个功能，并且在不断扩展中：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fmanager pull      <span class="comment">#更新当前分支的主工程，并将每个子模块的代码更新到指定分支的最新状态。</span></div><div class="line">fmanager update    <span class="comment"># ./fmanager pull 的别名</span></div><div class="line">fmanager checkout &lt;分支名&gt; <span class="comment"># 切换到某个主工程分支，同时完成子模块的代码切换。</span></div><div class="line">fmanager submodule update &lt;模块名列表&gt; <span class="comment"># 更新指定子模块的代码到所处分支的最新状态。</span></div><div class="line">fmanager showbranch <span class="comment"># 查看当前主工程和所有子模块的所属分支。</span></div><div class="line">fmanager status <span class="comment"># 查看当前主工程和所有子模块的修改状态。</span></div><div class="line">fmanager log <span class="comment"># 查看当前主工程和所有子模块的当前分支/标签和最新提交。</span></div><div class="line">fmanager cherry-pick &lt;commit id&gt; &lt;分支列表&gt; cherry-pick 某个 commit id 到分支列表。</div><div class="line">fmanager cherry-push &lt;commit id&gt; &lt;分支列表&gt; cherry-pick 某个 commit id 到分支列表，并推送这些分支。</div></pre></td></tr></table></figure></p>
<p>这个工具直接内置在主工程的根路径，并且接受一个 json 格式的配置文件 modules.json ，该配置文件大概长这样：</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">    "<span class="attribute">sub</span>": <span class="value">{        </span></div><div class="line">        "<span class="attribute">app</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master_dev"</span></span>}</span>,</div><div class="line">        "<span class="attribute">common</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master_dev"</span></span>}</span>,</div><div class="line">        "<span class="attribute">fmall</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master"</span></span>}</span>,</div><div class="line">        "<span class="attribute">framework</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"jilin"</span></span>}</span>,</div><div class="line">        "<span class="attribute">fund</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master_dev"</span></span>}</span>,</div><div class="line">        "<span class="attribute">hybrid</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master_dev"</span></span>}</span>,</div><div class="line">        "<span class="attribute">messagecenter</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master"</span></span>}</span>,</div><div class="line">        "<span class="attribute">property</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master"</span></span>}</span>,</div><div class="line">        "<span class="attribute">safetykeyboardnew</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master"</span></span>}</span>,</div><div class="line">        "<span class="attribute">scores</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master"</span></span>}</span>,</div><div class="line">        "<span class="attribute">thirdparty</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master_dev"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"jilin"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native/HFModules</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"jilin"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native/HFCommon</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master_dev"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native/node_modules</span>": <span class="value">{"<span class="attribute">branch</span>": <span class="value"><span class="string">"master"</span></span>}</span></div><div class="line"></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>不同的主工程分支，modules.json 配置文件的内容允许不同，且每个模块都允许指定不同分支。对于嵌套子模块，我们通过加上父模块前缀来做标识。</p>
<p>当使用 fmanager 切换分支时，fmanager 将首先完成主工程的分支切换，然后读入该分支下的 modules.json ，再根据 modules.json 的配置逐个切换到各自模块的指定分支。</p>
<p>使用 fmanager 更新工程和切换分支相似，只是顺便完成了子模块的 git pull 操作。</p>
<p>这样的子模块管理策略看起来有点“激进”：永远使用分支最新的代码状态。为了保证稳定性，我们还支持在 modules.json 中使用 tag ：</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">    "<span class="attribute">sub</span>": <span class="value">{        </span></div><div class="line">        "<span class="attribute">app</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">common</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">fmall</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">framework</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"jilin-2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">fund</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">hybrid</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">messagecenter</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">property</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">safetykeyboardnew</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">scores</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">thirdparty</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"jilin-2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native/HFModules</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"jilin-2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native/HFCommon</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span>,</div><div class="line">        "<span class="attribute">react_native/node_modules</span>": <span class="value">{"<span class="attribute">tag</span>": <span class="value"><span class="string">"2.0.1"</span></span>}</span></div><div class="line"></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>在项目后期，可以通过引用标签来保持整个工程的稳定性。同时，负责打包的机器每次打包时，都会顺便执行 <code>fmanager log</code> 产出一份包含当前所有子模块所处分支和最新一次 commit 的记录，方便追查问题。</p>
<h3 id="加个钩子：pre-commit">加个钩子：pre-commit</h3>
<p>要达到第二个目的，可以通过编写本地钩子 pre-commit 来实现。该钩子可以用来在 commit 前进行一些检查工作，并拒绝一些不合法的提交。针对我们的需求，可以写一个脚本检查提交中是否包含 commit id 的修改，如果有，就先重置那些修改再提交剩下的内容。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding: utf-8</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys,os,io,subprocess,json,re</div><div class="line"></div><div class="line">reload(sys)</div><div class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line">error_color = <span class="string">"\033[31m"</span></div><div class="line">warning_color = <span class="string">"\033[33m"</span></div><div class="line">normal_color = <span class="string">"\033[0m"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getRootPath</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># 找到工程根目录</span></div><div class="line">    git_path = <span class="string">".git"</span></div><div class="line">    pwd = os.getcwd()</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">if</span> os.path.exists(os.path.join(pwd, git_path)) <span class="keyword">and</span> os.path.isdir(os.path.join(pwd, git_path)):</div><div class="line">            <span class="keyword">return</span> os.path.abspath(pwd)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> (os.path.exists(os.path.join(pwd, <span class="string">"../"</span>))):</div><div class="line">                pwd = os.path.join(pwd, <span class="string">"../"</span>)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSubmoduleNameAndPath</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">'''获取子模块信息'''</span></div><div class="line">    root_path = getRootPath()</div><div class="line">    <span class="keyword">if</span> root_path != <span class="keyword">None</span>:</div><div class="line">        output = subprocess.Popen([<span class="string">'git submodule --quiet foreach \'echo $toplevel/$path\''</span>], stdout=subprocess.PIPE, shell=<span class="keyword">True</span>)</div><div class="line">        oc = output.communicate() <span class="comment">#取出output中的字符串</span></div><div class="line">        submodule_dict = {}</div><div class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> oc:</div><div class="line">            <span class="keyword">if</span> element != <span class="keyword">None</span>:</div><div class="line">                sb_list = element.split(<span class="string">'\n'</span>)</div><div class="line">                <span class="keyword">for</span> elem <span class="keyword">in</span> sb_list:</div><div class="line">                    <span class="keyword">if</span> (elem != <span class="string">""</span>):</div><div class="line">                        path = elem.strip()</div><div class="line">                        name = path.replace(root_path+<span class="string">"/"</span>, <span class="string">''</span>)</div><div class="line">                        submodule_dict[name] = path</div><div class="line">        <span class="keyword">return</span> submodule_dict</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        print(warning_color)</div><div class="line">        print(<span class="string">'''</span></div><div class="line">警告：检测到当前工程不是 .git 工程，文件目录可能已经损坏！</div><div class="line">''')</div><div class="line">        print(normal_color)</div><div class="line">        os.chdir(pwd)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkSubModule</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">'''防止提交子模块的 commit id'''</span></div><div class="line">    pwd = os.getcwd()</div><div class="line">    submodule_dict = getSubmoduleNameAndPath()</div><div class="line">    <span class="comment"># 判断每个子模块是否修改了commit id</span></div><div class="line">    <span class="keyword">for</span> module_name, module_path <span class="keyword">in</span> submodule_dict.items():</div><div class="line">        os.chdir(os.path.join(module_path, <span class="string">".."</span>))</div><div class="line">        module_basepath = os.path.basename(module_path)</div><div class="line">        output = subprocess.Popen([<span class="string">'git diff --cached '</span> + module_basepath], stdout=subprocess.PIPE, shell=<span class="keyword">True</span>)</div><div class="line">        oc = output.communicate()[<span class="number">0</span>]</div><div class="line">        <span class="comment"># 判断是否提交了 commit id 修改</span></div><div class="line">        <span class="keyword">if</span> oc.find(<span class="string">"-Subproject commit"</span>) &gt;= <span class="number">0</span> <span class="keyword">and</span> oc.find(<span class="string">"+Subproject commit"</span>) &gt;= <span class="number">0</span>:</div><div class="line">            print(warning_color)</div><div class="line">            print(<span class="string">'''</span></div><div class="line">检查到子模块 %s 提交了 commit id，</div><div class="line">我们强烈建议**不要**提交子模块的 commit id 改动！该 commit id 将被跳过提交。</div><div class="line">''' % module_name)</div><div class="line">            print(normal_color)</div><div class="line">            res = subprocess.call([<span class="string">'git'</span>, <span class="string">'reset'</span>, <span class="string">'HEAD'</span>, module_basepath])</div><div class="line">            <span class="keyword">if</span> res == <span class="number">0</span>:</div><div class="line">                print(<span class="string">"子模块 "</span> + module_name + <span class="string">" 的 commit id 重置成功！"</span>)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                print(error_color)</div><div class="line">                print(<span class="string">"子模块 "</span> + module_name + <span class="string">" 的 commit id 重置失败！"</span>)</div><div class="line">                print(normal_color)</div><div class="line">                os.chdir(pwd)</div><div class="line">                <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    os.chdir(pwd)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> checkSubModule():</div><div class="line">    exit(<span class="number">0</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    exit(<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>钩子编写完，还得解决安装问题。所谓“安装”，即是将 pre-commit 复制到根目录中的 .git/hooks 目录中，并确保可执行。听起来好像很简单，实则不然：</p>
<ol>
<li>.git 里的内容并不会随仓库一同提交。需要另外想其他办法让团队其他人“上钩”，并保持钩子的同步。</li>
<li>父工程的钩子不会被继承到子模块，也就是说，如果你希望一个钩子在父工程和多个子模块中用到，那你需要为每个仓库都添加一次钩子。</li>
</ol>
<p>fmanager 帮我们解决了第一个问题，由于我们用自己造的 fmanager 来更新工程代码，因此可以让 fmanager 在更新的时候自动完成钩子的安装。</p>
<p>而通过观察 .git 的文件结构，我发现每个子模块在 .git/modules 中各自拥有一个专属的数据目录。这个数据目录下也有一个 hooks 目录，该子模块的钩子就应该安装到这里。
如果有嵌套子模块，父模块的数据目录下还会有 modules 目录，并且可以一直这么嵌套下去。</p>
<p>解决这两个问题后，钩子顺利安装到了每个团队成员的仓库中，并且还能时刻保持同步。一旦有人试图提交 commit id 的修改，就会出现如下的错误：</p>
<p><img src="/images/enterprise-class-git-version-control-1/pre-commit.png" alt="利用 pre-commit 钩子实现跳过 commit id 提交"></p>
<p>而其他内容的修改依然可以正常提交。</p>
<p>pre-commit 钩子非常有用，我们陆续又添加了诸如代码风格检查、json 合法性检查、commit 邮箱合法性检查等测试。</p>
<h2 id="总结">总结</h2>
<p>通过本文的方法，我们对子模块的使用进行了简化，避免了由于漏提交子模块 commit id 或子模块代码导致无法更新或更新错误的情况。这么做看起来好像完全抛弃了子模块的 commit id ，但在下面的文章中，我将介绍一种自动更新子模块 commit id 的方法，该方法将利用 commit id 自动触发针对子模块的持续集成测试。</p>

		</div>

		<!-- jiathis -->
		
<!-- JiaThis Button BEGIN -->
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?type=left&amp;move=0&amp;btn=l2.gif&amp;uid=1538060" charset="utf-8"></script>
<!-- JiaThis Button END -->

        

		<!-- pagination -->
		<div>
		<center>
		<div class="pagination">
	 
      <ul>
		
		<li class="prev"><a data-pjax href="/work/enterprise-class-git-version-control-2/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

		<li><a data-pjax href="/archive"><i class="fa fa-archive"></i>Archive</a></li>

        
			<li class="next"><a data-pjax href="/codes/learn-react-native-for-android-02/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>           
      </ul>
	
</div>

	        </center>
		</div>

        <!-- donate -->
        <!-- Donate Module -->
<div id="donate_module">
	<!-- css -->
	<style type="text/css">
		.donate_bar a.btn_donate{
			display: inline-block;
			width: 82px;
			height: 82px;
			background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			_background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			<!-- 因为本 hexo 生成的博客所用的 theme 的 a:hover 带动画效果，
				 为了在让打赏按钮显示效果正常 而 添加了以下几行 css，
				 嵌入其它博客时不一定要它们。 -->
			-webkit-transition: background 0s;
			-moz-transition: background 0s;
			-o-transition: background 0s;
			-ms-transition: background 0s;
			transition: background 0s;
			<!-- /让打赏按钮的效果显示正常 而 添加的几行 css 到此结束 -->
		}
		.donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
		.donate_bar .donate_txt {
			display: block;
			color: #9d9d9d;
			font: 14px/2 "Microsoft Yahei";
		}
		.bold{ font-weight: bold; }
	</style>
	<!-- /css -->
	<!-- btn_donate & tips -->
	<div id="donate_board" class="donate_bar center">
		<a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
	</div>
	<!-- /btn_donate & tips -->
	<!-- donate guide -->
	<div id="donate_guide" class="donate_bar center hidden">
        <div class="row center">
		<a href="http://7xj89i.com1.z0.glb.clouddn.com/ali_pay_01.jpg" title="Alipay_Scan_Payment" class="fancybox">
			<img src="http://7xj89i.com1.z0.glb.clouddn.com/ali_pay_01.jpg" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>&nbsp;
		<a href="http://7xj89i.com1.z0.glb.clouddn.com/wechat_pay_02.png" title="WeChat_Scan_Payment" class="fancybox">
			<img src="http://7xj89i.com1.z0.glb.clouddn.com/wechat_pay_02.png" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>
        </div>
		<span class="donate_txt">
			Use App <span class="bold"><a href="http://global.alipay.com/ospay/home.htm">Alipay</a> / <a href="http://www.wechat.com/en/">WeChat</a></span>
			to scan QRCode~ Thx for your support.<br/>
			用手机 <span class="bold"><a href="https://mobile.alipay.com/index.htm">支付宝钱包</a> / <a href="http://weixin.qq.com/">微信</a></span>，
			扫一扫即可~ 谢谢您的鼓励。<br/>
			<br/>
		</span>
		<br/>
	</div>
	<!-- /donate guide -->
	<!-- donate script -->
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
		function donate_on_web(){
			$('#donate').submit();
		}
	</script>
	<!-- /donate script -->
</div>
<!-- /Donate Module -->


		<!-- toc -->
		
   	<script type="text/javascript">
		jQuery(document).ready(function() {
				
		   generatePostTOC('.mypage',  2 , 2 );
		
		});
	</script>




		<!-- comment -->
		
<section id="comment">
    <h2 class="title">Comments</h2>
	
	 <div id="comment-thread"></div>
	 <div id="loading-spin"></div>
	 <script type="text/javascript">
	   getComments({
		       type: "github",
	           user: "wzpan",
	           repo: "wzpan.github.io",
			   reversed_token: "232b130b29af1ea018cec5eea694fd2be76b4cd1",
			   no_comment: "暂时还没有留言呢，点击下面的按钮去留言吧！",
			   go_to_comment: "去留言",
			   btn_class: "btn btn-primary",
			   no_issue: "no_issue",
			   issue_title: "化繁为简的企业级 Git 管理实践（一）：多分支子模块依赖管理",
			   issue_id: "undefined",
			   comments_target: "#comment-thread" ? "#comment-thread" : "#comment-thread",
			   loading_target: "#loading-spin"
			   });
	 </script>
	
</section>



		
	</div> <!-- span9/span12 -->
	
		<div class="span3">

	<!-- donate -->
	<div class="meta-widget">
	<a href="#donate_module"><i class="fa fa-smile-o"></i> Donate this article</a>
	</div>

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	Apr 13 2016 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a data-pjax href="/categories/work/">work<span>5</span></a></li>
  </li>

    </ul>
	</div>
	
	
  	<!-- tags -->
	
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a data-pjax href="/tags/Git/">Git<span>5</span></a></li> <li><a data-pjax href="/tags/Python/">Python<span>2</span></a></li>

    </ul>
	</div>
		
	
    <hr>
</div><!-- span3 -->

	

</div><!-- row-fluid post-full -->

	</div>	
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2017 Joseph Pan
  
      with help from <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and 
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1254469760'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1254469760' type='text/javascript'%3E%3C/script%3E"));</script>
. 
    <small>
     <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="/images/license.png"></a>
    </small>
</p>
 </footer>
</div> <!-- container-narrow -->


<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/dist/jquery.imagesloaded.min.js"></script>


<script src="/dist/gallery.min.js"></script>
<script src="/dist/bootstrap.min.js"></script>
<script src="/dist/jquery.tableofcontents.min.js"></script>
<script src="/dist/tocgenerator.min.js"></script>
<script src="/dist/require.min.js"></script>
<script src="/dist/main.min.js"></script>


<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

  _st('install','ney3Rb77vMaWT2KUKFyt');
</script>


</body>
</html>
