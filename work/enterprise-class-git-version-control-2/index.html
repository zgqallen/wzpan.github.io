<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>化繁为简的企业级 Git 管理实战（二）：多分支子模块持续集成 | HaHack</title>
  <meta name="author" content="Joseph Pan">
  
  <meta name="description" content="在本篇文章中，我仔细讨论了对子模块进行持续集成的三种方案，并利用自动化手段实现逐层往上提交子模块 commit id 从而触发主工程构建。这些构建结果为我们快速定位工程的编译问题提供了重要的线索。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="化繁为简的企业级 Git 管理实战（二）：多分支子模块持续集成"/>
  <meta property="og:site_name" content="HaHack"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/images/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="HaHack" type="application/atom+xml">
  
  <link rel="stylesheet" href="/dist/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bootstrap-responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/font-awesome.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/style.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/highlight.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/sidenav.min.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/dist/responsive.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/bubble.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/google-fonts.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/nprogress.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/dist/comment.min.css" media="screen" type="text/css">
  
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <!--[if lte IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  <![endif]-->

<!--  -->
<!--     <link href='https://fonts.googleapis.com/css?family=PT+Sans+Narrow|PT+Sans:400,400italic,700,700italic|Droid+Serif:400,400italic' rel='stylesheet' type='text/css'> -->
<!--     <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'> -->
<!--  -->
  
<script src="/dist/jquery-2.0.3.min.js"></script>


    <script src="/dist/videoGFW.min.js"></script>
	
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-41569408-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;

ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';

var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

	


    <link rel="stylesheet" href="/dist/highlight-default.min.css" media="screen" type="text/css">
    
    <script src="/dist/comment.min.js"></script>
    <script src="/dist/marked.min.js"></script>
    
    <script src="/dist/highlight.min.js"></script>
    <script src="/dist/timeago.min.js"></script>
	<script src="/dist/spin.min.js"></script>


</head>


<body data-spy="scroll" data-target=".toc">  
  <header id="header" class="inner"><div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
            <a data-pjax class="brand" href="/">HaHack</a>
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <div class="nav-collapse collapse">
            <ul class="nav">				
			    
				   <li><a data-pjax href="/archive" title="所有文章归档"><i class="fa fa-archive"></i>Archive</a></li>
    			
				   <li><a data-pjax href="/categories" title="所有文章分类"><i class="fa fa-folder"></i>Categories</a></li>
    			
				   <li><a data-pjax href="/tags" title="所有文章标签"><i class="fa fa-tags"></i>Tags</a></li>
    			
				
				<li class="divider-vertical"></li>
			   	<li><a data-pjax href="/wiki" title="我的笔记库"><i class="fa fa-tasks"></i>wiki</a></li>				   
				
            </ul>			
			<ul class="nav navright">
				<li class="dropdown works">
				<a data-pjax href="#" title="作品集" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-th-large"></i>Works <b class="caret"></b></a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">				
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://github.com/wzpan/wukong-robot" title="wukong-robot 是一个简单、灵活、优雅的中文语音对话机器人。"><i class="fab fa-github"></i>wukong-robot</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://github.com/dingdang-robot/dingdang-robot" title="叮当是一款可以工作在 Raspberry Pi 上的中文语音对话机器人/智能音箱项目。"><i class="fab fa-github"></i>dingdang-robot</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://github.com/wzpan/comment-js" title="纯JS实现的静态站点评论系统，使用 Github/OSChina 作为 backend。"><i class="fab fa-github"></i>comment.js</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://github.com/wzpan/qtevm" title="首个完整的 C++ 开源实现，能同时放大动作变化和颜色变化"><i class="fab fa-github"></i>QtEVM</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/wzpan/wzpan.github.io/wiki/hexo-series" title="为 Hexo 写的一系列主题/工具/插件"><i class="fab fa-github"></i>hexo-series</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/scnu/scnuthesis" title="符合华南师范大学硕士/博士学位论文格式要求的LaTeX模板。"><i class="fab fa-github"></i>SCNUThesis</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://github.com/wzpan/wzpan.github.io/wiki/slides" title="一些幻灯片作品"><i class="fab fa-github"></i>Slides</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="http://hahack.com/codes/fcevm/" title="硕士毕业论文"><i class="fab fa-github"></i>Dissertation</a></li>
				
                </ul>                
				</li>
                <li class="dropdown works">
				<a data-pjax href="#" title="课程" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-video"></i>Courses <b class="caret"></b></a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
                
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://ke.qq.com/course/list/python%20next%20潘伟洲" title="Python 从入门到实践系列"><i class="fa fa-video"></i>Python</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://ke.qq.com/course/326820" title="微信小游戏入门与实战"><i class="fa fa-video"></i>minigame</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" target="_blank" href="https://ke.qq.com/course/350627" title="使用Cocos Creator开发微信小游戏《2048》"><i class="fa fa-video"></i>2048</a></li>
				
                </ul>                
				</li>                
				<li class="dropdown">
				<a data-pjax href="#" title="订阅本站" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-rss"></i>Subscribe <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="drop2">
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/atom.xml" title="使用 RSS 阅读器订阅 HaHack"><i class="fa fa-rss-square"></i>RSS</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="/wechat.html" title="订阅 HaHack 的公众平台"><i class="fa fa-qrcode"></i>WeChat</a></li>
				
				   <li role="presentation"><a role="menuitem" tabindex="-1" href="http://toutiao.io/u/147640" title=""><i class="fa fa-align-justify"></i>Toutiao</a></li>
				
                	        </ul>
				</li>
				
				<li><a data-pjax href="/about" title="关于我"><i class="fa fa-user"></i>About</a></li>				   				
   					  
            </ul>
            </div> <!-- nav-collapse collapse -->
        </div> <!-- container -->
     </div> <!-- navbar-inner -->
</div> <!-- navbar navbar-inverse -->
</header>
  <div class="container" id="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> 化繁为简的企业级 Git 管理实战（二）：多分支子模块持续集成</h1>
		</div>    
	





<div class="row-fluid post">
	<!-- span -->
	
	<div class="span9">
	

	<!-- <div class="alert alert-error">
	<button type="button" class="close" data-dismiss="alert">&times;</button>
	<i class="fa fa-gift"></i> 过年了，<a href="/donate.html" target="_blank">给HaHack派个红包吧</a>！
</div> -->

	
		<div class="alert alert-success">
			<i class="fa fa-info-circle"></i> <p>在本篇文章中，我仔细讨论了对子模块进行持续集成的三种方案，并利用自动化手段实现逐层往上提交子模块 commit id 从而触发主工程构建。这些构建结果为我们快速定位工程的编译问题提供了重要的线索。</p>

		</div> <!-- alert -->
	
		   

		<!-- content -->
		<div class="mypage">
		<h2 id="需求描述">需求描述</h2>
<p>在 <a href="/work/enterprise-class-git-version-control-1/">上一篇文章</a> 中，我简单描述了我们一个项目的复杂程度：子模块、嵌套子模块、多分支。除了工程分支切换上的复杂，我们还遇到另一个问题：子模块持续集成。</p>
<h2 id="主工程持续集成">主工程持续集成</h2>
<p>先说说主工程如何做持续集成。我们使用 Gitlab 自带的 <a href="https://about.gitlab.com/gitlab-ci/" target="_blank" rel="external">Gitlab-Ci</a> 作为我们的持续集成系统。Android 端的主工程的持续集成脚本如下：</p>
<p><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">build:</div><div class="line">  tags:</div><div class="line">    -<span class="ruby"> android</span></div><div class="line">  script:</div><div class="line">    -<span class="ruby"> ./fmanager checkout -f <span class="variable">$CI_BUILD_REF_NAME</span></span></div><div class="line">    -<span class="ruby"> ./fmanager update</span></div><div class="line">    -<span class="ruby"> gradle clean</span></div><div class="line">    -<span class="ruby"> gradle aR</span></div></pre></td></tr></table></figure></p>
<p>其中， <code>CI_BUILD_REF_NAME</code> 指定要编译哪个分支的主工程。当我们推送代码到某个分支时，该分支下的持续集成脚本就会被调用，<code>CI_BUILD_REF_NAME</code> 变量就会是那个分支的名字。在执行构建前，先用 fmanager 完成主工程和所有模块的分支切换 ，之后再用 fmanager 更新整个项目的代码。最后再执行编译指令。 <a id="more"></a></p>
<p>主工程的持续集成就是这么简单。然而这远远不能满足我们的需求：我们的工程有多个子模块。一个子模块的某个分支可能被多个父模块的多个分支依赖。例如，common 模块的 master_dev 分支可能被 framework 模块的 master_dev、jilin_dev、taishan_dev 分支依赖。在这样的情况下，任何一个子模块如果不注意提交前自测，都有可能导致多个分支的整个工程编译失败，阻塞多个分支的开发进度。比这更困难的是，对某个模块的修改也许可以保证在当前主工程分支上编译通过，但却意外导致了另外一个依赖该子模块的主工程分支的编译失败。</p>
<p>因此，我们除了要对主工程进行持续集成测试之外，也不得不对子模块做持续集成测试：任何一个子模块某个分支一旦推送了代码，就触发所有依赖它的主工程的分支的持续集成测试。为了实现这个目标，我们尝试了三种方案。</p>
<h2 id="方案一：trigger">方案一：trigger</h2>
<p>第一种方案是利用 Gitlab-Ci 的 <a href="http://doc.gitlab.com/ce/ci/triggers/README.html" target="_blank" rel="external">trigger</a> 机制。trigger 提供了直接在脚本中触发任何一个仓库的持续集成的方法。利用 trigger，我们可以为子模块也写一份持续集成脚本，而它仅仅用来触发依赖它的所有主工程的分支的持续集成。例如，假如主工程的 master_dev 分支和 jilin_dev 分支都依赖了 framework 子模块的 master_dev 分支，那么可以为 framework 的 master_dev 编写一个持续集成脚本：</p>
<p><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">build:</div><div class="line">  stage: deploy</div><div class="line">  script:</div><div class="line">    -<span class="ruby"> <span class="string">"curl -X POST -F token=3ef8939a8e50c5e98f459789b966a4 -F ref=refs/heads/master_dev http://yourcompany.com/api/v3/projects/10/trigger/builds"</span></span></div><div class="line">    -<span class="ruby"> <span class="string">"curl -X POST -F token=3ef8939a8e50c5e98f459789b966a4 -F ref=refs/heads/jilin_dev http://yourcompany.com/api/v3/projects/10/trigger/builds"</span></span></div></pre></td></tr></table></figure></p>
<p>其中，<code>ref</code> 参数指定了要触发持续集成测试的项目的分支。这样，当中央仓库上 framework 模块的 master_dev 分支有新的代码推送时，主工程的 master_dev 分支和 jilin_dev 分支就会触发构建：</p>
<p><img src="/images/enterprise-class-git-version-control-2/trigger.png" alt=""></p>
<p>使用 trigger 虽然能有效触发所依赖的主工程的分支，但它有很多不足之处：</p>
<p>1、维护成本高。每个子模块都需要编写持续集成脚本，且由于主工程经常需要新增新业务分支，需要频繁维护每个子模块的持续集成脚本，添加依赖它的分支。
2、无法跟踪。子模块的持续集成脚本的作用仅仅只是触发了主工程的持续集成，而当次触发的结果并不会返回给子模块作为子模块持续集成的结果：</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">gitlab-ci-multi-runner 1.0.4 (014aa8c)</div><div class="line">Using Shell executor...</div><div class="line">Running on appdevdeiMac.local...</div><div class="line">Fetching changes...</div><div class="line">HEAD is now at 826d126 <span class="operator"><span class="keyword">Merge</span> branch <span class="string">'master_dev'</span> <span class="keyword">of</span> http://yourcompany.com/yourgroup/framework_android <span class="keyword">into</span> master_dev</span></div><div class="line"><span class="keyword">From</span> http://yourcompany.com/FFProject/appframework_android</div><div class="line">   <span class="number">826</span>d126.<span class="number">.13</span>ba8f3  master_dev -&gt; origin/master_dev</div><div class="line">Checking out <span class="number">13</span>ba8f33 <span class="keyword">as</span> master_dev...</div><div class="line">Previous HEAD <span class="keyword">position</span> was <span class="number">826</span>d126... <span class="keyword">Merge</span> branch <span class="string">'master_dev'</span> <span class="keyword">of</span> http://yourcompany.com/yourgroup/framework <span class="keyword">into</span> master_dev</div><div class="line">HEAD <span class="keyword">is</span> <span class="keyword">now</span> <span class="keyword">at</span> <span class="number">13</span>ba8f3... [master_dev][bank][c:panweizhou][r:chendingyi]<span class="keyword">update</span> ci script.</div><div class="line">$ curl -X POST -F token=<span class="number">2587402741</span>a9ef3a09d0dd64f83b90 -F ref=$CI_BUILD_REF_NAME http://yourcompany.com/api/v3/projects/<span class="number">11</span>/<span class="keyword">trigger</span>/builds</div><div class="line">  % Total    % Received % Xferd  Average Speed   <span class="keyword">Time</span>    <span class="keyword">Time</span>     <span class="keyword">Time</span>  <span class="keyword">Current</span></div><div class="line">                                 Dload  Upload   Total   Spent    <span class="keyword">Left</span>  Speed</div><div class="line">  <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>      <span class="number">0</span>      <span class="number">0</span> <span class="comment">--:--:-- --:--:-- --:--:--     0100   298  100    26  100   272    220   2304 --:--:-- --:--:-- --:--:--  2324</span></div><div class="line">{<span class="string">"id"</span>:<span class="number">48</span>,<span class="string">"variables"</span>:<span class="literal">null</span>}</div><div class="line">Build succeeded.</div></pre></td></tr></table></figure></p>
<p>所以子模块的持续集成一直是成功的：</p>
<p><img src="/images/enterprise-class-git-version-control-2/all-success.png" alt=""></p>
<p>而实际却可能早已导致主工程编译失败：</p>
<p><img src="/images/enterprise-class-git-version-control-2/all-fail.png" alt=""></p>
<p>3、无法定位触发源。主工程的构建日志页仅记录触发本次构建的 trigger 的 Token 。但这个 trigger 是主工程自己的 <code>--bb</code> 。</p>
<p><img src="/images/enterprise-class-git-version-control-2/trigger-token.png" alt=""></p>
<p>换句话说，除非为每一个子模块提供一个单独的 Token ，否则我们根本无法判断究竟是子模块触发了这个 trigger 。第一种方案歇菜。</p>
<h2 id="方案二：子模块测试工程">方案二：子模块测试工程</h2>
<p>第二种方案是为所有需要做集成测试的子模块都单独编写一个测试工程。当子模块有推送代码时，不再触发主工程的持续集成，而是触发测试工程的持续集成。</p>
<p>由于每个子模块与其测试工程是一对一的关系，一旦测试工程编译失败，那其对应的子模块就很有可能存在问题。然而这个方案也有很大的局限性。</p>
<ol>
<li>需要为每个核心子模块都维护一个测试工程，且测试工程的开发进度需要一直与主工程同步。当测试工程的维护进度落后于主工程，就有可能出现子模块能保证主工程编译通过，却导致测试工程编译不过。</li>
<li>当子模块有多个分支时，每个重要分支都需要相应建立测试工程的分支，这使得测试工程的维护成本同比增加。</li>
<li>最致命的问题是：子模块的测试工程仅仅只能覆盖子模块，而整个主工程由多个子模块组合而成的，模块与模块之间也有相互依赖关系，模块级别的覆盖度并不足以保证整个工程的可编译。</li>
</ol>
<p>综上所述，用子模块测试工程来对子模块进行持续集成并不理想。方案二也失败了。看来 trigger 并不适合用来解决我们的问题，于是我对 trigger 的尝试也到此为止。</p>
<h2 id="方案三：自动更新子模块-commit-id">方案三：自动更新子模块 commit id</h2>
<p>前面两种方案走不通，我开始思考：Git 难道就没有关于子模块持续集成的 best practice 吗？直到我看到了 <a href="https://blog.blahgeek.com/gitlab-ci-build-multi-repo/" target="_blank" rel="external">blahgeek 的这篇文章</a> ，里头提出用 commit id 的改动来触发工程更新，顿时恍然大悟：Git 本身建议通过在主工程记录子模块的 commit id 来控制子模块的版本。除了控制版本，commit id 其实还有另一个好处，那就是持续集成！子模块发生修改后，为了让主工程同步该子模块的更新，你需要不断往上提交上层模块的 commit id ，这就会顺带触发主工程的持续集成。</p>
<p>然而，<a href="/work/enterprise-class-git-version-control-1/">上一篇文章</a>中提到，为了避免只提 commit id 没提代码的情况发生，我们直接禁止了 commit id 的提交。矛盾来了。</p>
<p>幸运的是我们有折中的办法。如果子模块代码已推送成功，那么此时该模块在父工程中的 commit id 一定可以更新。而这个更新为什么不能让计算机帮忙自动完成？我只需要在子模块的中央仓库中加入 post-receive 钩子，当子模块代码推送完成时，post-receive 钩子里的脚本就会自动被触发，帮助我们到上层提交该子模块的 commit id 。对于嵌套子模块，这个过程会一直递归地做，直到父工程就是主工程为止，而这最终就会触发主工程的持续集成！</p>
<p>方法听起来可行，但实际做起来我依然遇到了不少困难。</p>
<p>首先，服务器上的仓库都是 bare repository ，不能提交代码，也没有相互依赖关系，主工程和所有子模块的仓库都是平级的存放在同个目录下的。这意味着你无法利用 post-receive 钩子原地地修改自身仓库和依赖它的其他仓库。</p>
<p>其次，依赖每个子模块的父工程及分支各不相同。当一个子模块的某个分支有更新时，你需要为父工程中为所有依赖该子模块那个分支的全部分支都提交一遍新的 commit id 。</p>
<p>最后，每一个子模块也都需要安装一个这样的 post-receive 钩子，且子模块经常需要新增，依赖关系也经常变动，维护成本高。</p>
<p>解决第一个问题的方法就是在服务器也像本地那样 clone 出一份整个工程的 working repository ，这个工程和我们本地开发的仓库没什么区别，交给服务器来自动维护。唯一的难点在于怎么将每个 bare repository 与该 working repository 里的每个子模块相关联。于是，只需要写个工具，遍历一遍所有主工程分支，并生成每个分支所依赖的每个子模块的仓库地址与本地路径信息。内容类似这样：</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">    "master": {        </div><div class="line">        "app": {"branch": "master"},</div><div class="line">        "common": {"branch": "master"},</div><div class="line">        ...</div><div class="line">        "react_native/node_modules": {"branch": "master"}</div><div class="line">    },</div><div class="line">    "master_dev": {        </div><div class="line">        "app": {"branch": "master_dev"},</div><div class="line">        "common": {"branch": "master_dev"},</div><div class="line">        ...</div><div class="line">        "react_native/node_modules": {"branch": "master"}</div><div class="line">    },</div><div class="line">    "jilin": {        </div><div class="line">        "app": {"branch": "master"},</div><div class="line">        "common": {"branch": "master"},</div><div class="line">        ...</div><div class="line">        "react_native/node_modules": {"branch": "jilin"}</div><div class="line">    },</div><div class="line">    "jilin_dev": {        </div><div class="line">        "app": {"branch": "master"},</div><div class="line">        "common": {"branch": "master"},</div><div class="line">        ...</div><div class="line">        "react_native/node_modules": {"branch": "jilin_dev"}</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>解决第二个问题的方法就是利用每个主工程分支的 modules.json 。我们在主工程的每个分支上都编写了一份 modules.json ，这个文件记录了所有子模块的依赖关系。只要对所有分支的 modules.json 进行归并，就可以得到一份完整的记录所有模块所有分支的依赖关系。内容类似这样：</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">app:</div><div class="line">    repo: http://yourcampany.com/yourgroup/app_android.git</div><div class="line">    path: /home/git/app_android</div><div class="line"></div><div class="line">common:</div><div class="line">    repo: http://yourcampany.com/yourgroup/core_lib_android.git</div><div class="line">    path: /home/git/app_android/common</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">node_modules:</div><div class="line">    repo: http://yourcampany.com/yourgroup/node_modules.git</div><div class="line">    path: /home/git/app_android/react_native/node_modules</div></pre></td></tr></table></figure></p>
<p>有了这两个文件，post-receive 钩子也就可以写得通用化：先获取该子模块的仓库名，然后根据这个文件找到在 working repository 下对应的目录，然后用 fmanager 切到依赖该子模块该分支的主工程。更新该子模块的 working tree ，最后 cd 到上级目录提交该子模块的 commit id 。</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#author:panweizhou</span></div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">After push, automatically update commit id of current submodule.</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line">sys.path.append(<span class="string">'/usr/lib/python2.6/site-packages'</span>)</div><div class="line">sys.path.append(<span class="string">'/usr/lib64/python2.6/site-packages'</span>)</div><div class="line"></div><div class="line"><span class="keyword">import</span> fileinput</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> yaml</div><div class="line"><span class="keyword">from</span> filelock <span class="keyword">import</span> FileLock</div><div class="line"></div><div class="line">module_file = <span class="string">"/home/git/modules/modules_android.json"</span></div><div class="line">module_path_file = <span class="string">"/home/git/modules/modules_android.yml"</span></div><div class="line">project_root = <span class="string">"/home/git/app_android"</span></div><div class="line">env_path = <span class="string">"/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin:/usr/local/libexec/git-core/:/home/git/bin"</span></div><div class="line"></div><div class="line">lock_file_name = <span class="string">"/tmp/"</span> + os.path.basename(os.getcwd())</div><div class="line"></div><div class="line"><span class="keyword">with</span> FileLock(lock_file_name):</div><div class="line">    <span class="keyword">print</span> (<span class="string">"Updating commit id"</span>)</div><div class="line">    <span class="comment"># read global module config</span></div><div class="line">    global_module_config = {}</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">with</span> open(module_file) <span class="keyword">as</span> f:</div><div class="line">            global_module_config = json.load(f)</div><div class="line">    <span class="keyword">except</span> ValueError:</div><div class="line">        print(<span class="string">"Global modules.json parsed Error!"</span>)</div><div class="line">        exit(<span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="comment"># Read in each ref that the user is trying to update</span></div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> fileinput.input():</div><div class="line">        line = line.strip()</div><div class="line">        (from_commit, to_commit, ref) = line.split(<span class="string">' '</span>)</div><div class="line"></div><div class="line">        <span class="comment"># Get branch name</span></div><div class="line">        pos = ref.rfind(<span class="string">'/'</span>)</div><div class="line">        <span class="keyword">if</span> pos &gt;= <span class="number">0</span>:</div><div class="line">            branch = ref[pos+<span class="number">1</span>:]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            branch = ref</div><div class="line"></div><div class="line">        <span class="keyword">if</span> branch == <span class="string">'master'</span> <span class="keyword">or</span> branch.lower().endswith(<span class="string">'bank'</span>) <span class="keyword">or</span> branch.endswith(<span class="string">'_dev'</span>):</div><div class="line">        <span class="comment"># if branch == 'WeiZhouBank_dev':</span></div><div class="line">            <span class="comment"># Get repo name</span></div><div class="line">            output = subprocess.Popen([<span class="string">'git summary | egrep "^ project"'</span>], env={<span class="string">"PATH"</span>: env_path}, stdout=subprocess.PIPE, shell=<span class="keyword">True</span>)</div><div class="line">            oc = output.communicate()[<span class="number">0</span>]</div><div class="line">            repo = oc.split(<span class="string">':'</span>)[<span class="number">1</span>].strip()</div><div class="line"></div><div class="line">            <span class="comment"># Get the corresponding working path</span></div><div class="line">            module_path_info = {}</div><div class="line">            <span class="keyword">with</span> open (module_path_file) <span class="keyword">as</span> f:</div><div class="line">                module_path_info = yaml.load(f)</div><div class="line">            module_path = <span class="string">""</span></div><div class="line">            module_name = <span class="string">""</span></div><div class="line">            <span class="keyword">for</span> module_name, module_info <span class="keyword">in</span> module_path_info.items():</div><div class="line">                <span class="keyword">if</span> module_info.has_key(<span class="string">'repo'</span>):</div><div class="line">                    module_repo = module_info[<span class="string">"repo"</span>]</div><div class="line">                    <span class="keyword">if</span> module_repo.endswith(repo):</div><div class="line">                        has_such_module = <span class="keyword">True</span></div><div class="line">                        module_path = module_info[<span class="string">"path"</span>]                       </div><div class="line">                        <span class="keyword">break</span></div><div class="line">                        </div><div class="line">            <span class="comment"># Get all the main projects branch that use this module</span></div><div class="line">            main_branch_set = set()</div><div class="line">            <span class="keyword">for</span> branch_name, config_list <span class="keyword">in</span> global_module_config.items():</div><div class="line">                <span class="keyword">if</span> config_list.has_key(module_name):</div><div class="line">                    mconfig = config_list[module_name]</div><div class="line">                    <span class="keyword">if</span> (mconfig.has_key(<span class="string">'branch'</span>)):</div><div class="line">                        mbranch = mconfig[<span class="string">'branch'</span>]</div><div class="line">                        <span class="keyword">if</span> branch == mbranch:</div><div class="line">                            main_branch_set.add(branch_name)</div><div class="line"></div><div class="line">            <span class="comment"># Do the following stuff for each branch of main project</span></div><div class="line">            <span class="comment"># that use this module of this branch</span></div><div class="line">            <span class="keyword">for</span> main_branch <span class="keyword">in</span> main_branch_set:</div><div class="line">                os.chdir(project_root)</div><div class="line">                output = subprocess.Popen([<span class="string">"./fmanager checkout -f %s"</span> % main_branch], env={<span class="string">"PATH"</span>: env_path}, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=<span class="keyword">True</span>)</div><div class="line">                res = output.wait()</div><div class="line">                <span class="keyword">if</span> res == <span class="number">0</span>:</div><div class="line">                    os.chdir(module_path)</div><div class="line">                    <span class="comment"># update current submodule </span></div><div class="line">                    output = subprocess.Popen([<span class="string">'/home/git/bin/update_root'</span>, branch], cwd=module_path, env={<span class="string">"PATH"</span>: env_path})</div><div class="line">                    res = output.wait()</div><div class="line">                    <span class="keyword">if</span> res == <span class="number">0</span>:</div><div class="line">                        <span class="comment"># Get commit log</span></div><div class="line">                        output = subprocess.Popen([<span class="string">'git log -n 1'</span>], env={<span class="string">"PATH"</span>: env_path}, cwd=module_path, stdout=subprocess.PIPE, shell=<span class="keyword">True</span>)</div><div class="line">                        commit_log = output.communicate()[<span class="number">0</span>]</div><div class="line">                        commit_log = <span class="string">"Bump Version for submodule %s:\n\n%s"</span> % (module_name, commit_log)</div><div class="line">                        <span class="comment"># Go to father module</span></div><div class="line">                        os.chdir(<span class="string">'..'</span>)</div><div class="line">                        father_path = os.getcwd()</div><div class="line">                        <span class="comment"># Get branch of father module</span></div><div class="line">                        output = subprocess.Popen([<span class="string">'git'</span>, <span class="string">'symbolic-ref'</span>, <span class="string">'--short'</span>, <span class="string">'HEAD'</span>], stdout=subprocess.PIPE, stderr=subprocess.PIPE, env={<span class="string">"PATH"</span>: env_path})</div><div class="line">                        oc = output.communicate()</div><div class="line">                        father_branch = oc[<span class="number">0</span>].strip()</div><div class="line">                        <span class="keyword">if</span> (father_branch.strip() != <span class="string">""</span>):</div><div class="line">                            print(<span class="string">"Bumping version of branch %s of father project..."</span> % father_branch)</div><div class="line">                            output = subprocess.Popen([<span class="string">'/home/git/bin/update_root'</span>, father_branch], cwd=father_path, env={<span class="string">"PATH"</span>: env_path})</div><div class="line">                            res = output.wait()</div><div class="line">                            <span class="keyword">if</span> res == <span class="number">0</span>:</div><div class="line">                                output = subprocess.Popen([<span class="string">'git diff | wc -l'</span>], cwd=father_path, env={<span class="string">"PATH"</span>: env_path}, stdout=subprocess.PIPE, shell=<span class="keyword">True</span>)</div><div class="line">                                diff_num = output.communicate()[<span class="number">0</span>]</div><div class="line">                                <span class="keyword">if</span> diff_num &gt; <span class="number">1</span>:</div><div class="line">                                    subprocess.call([<span class="string">'git'</span>, <span class="string">'add'</span>, module_name], env={<span class="string">"PATH"</span>: env_path})</div><div class="line">                                    output.wait()</div><div class="line">                                    output = subprocess.Popen([<span class="string">'git'</span>, <span class="string">'commit'</span>, <span class="string">'-m'</span>, commit_log, <span class="string">'--no-verify'</span>], env={<span class="string">"PATH"</span>: env_path})</div><div class="line">                                    res = output.wait()</div><div class="line">                                    <span class="keyword">if</span> res == <span class="number">0</span>:</div><div class="line">                                        output = subprocess.Popen([<span class="string">'git'</span>, <span class="string">'push'</span>, <span class="string">'origin'</span>, <span class="string">'HEAD'</span>, <span class="string">'--no-verify'</span>], env={<span class="string">"PATH"</span>: env_path})</div><div class="line">                                        output.wait()</div><div class="line">                                        <span class="keyword">if</span> res == <span class="number">0</span>:</div><div class="line">                                            <span class="keyword">print</span> <span class="string">"Successfully bumped version branch %s of father project"</span> % father_branch</div><div class="line">                                        <span class="keyword">else</span>:</div><div class="line">                                            <span class="keyword">print</span> <span class="string">"Error bumping version for branch %s of father project"</span> % father_branch</div><div class="line">                                <span class="keyword">else</span>:</div><div class="line">                                    <span class="keyword">print</span> <span class="string">"Error bumping version for branch %s of father project"</span> % father_branch</div><div class="line">                            <span class="keyword">else</span>:</div><div class="line">                                <span class="keyword">print</span> <span class="string">"Error bumping version for branch %s of father project"</span> % father_branch</div><div class="line">                        <span class="keyword">else</span>:</div><div class="line">                            print(<span class="string">"Father project is a tag. Stop bumping verison."</span>)</div><div class="line">                    <span class="keyword">else</span>:</div><div class="line">                        <span class="keyword">print</span> <span class="string">"Error updating the remote working tree."</span></div></pre></td></tr></table></figure></p>
<p>之后只需将钩子安装到每个子模块的 bare repository 里的 custom_hooks 目录下。同样可以利用脚本来一次性完成。</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/bash</span></div><div class="line"><span class="comment">#author: panweizhou</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> module <span class="keyword">in</span> `ls <span class="operator">-d</span> *_android.git`</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> test <span class="variable">$module</span> != <span class="string">"App_Android.git"</span>  <span class="comment"># Don't install to root project</span></div><div class="line">    <span class="keyword">then</span></div><div class="line">        module_dir=<span class="variable">${module}</span></div><div class="line">        <span class="keyword">if</span> test ! <span class="operator">-d</span> <span class="variable">${module_dir}</span>/custom_hooks</div><div class="line">        <span class="keyword">then</span></div><div class="line">            mkdir <span class="variable">${module_dir}</span>/custom_hooks</div><div class="line">        <span class="keyword">fi</span></div><div class="line">        <span class="keyword">for</span> hook <span class="keyword">in</span> `ls submodule_hooks_android`</div><div class="line">        <span class="keyword">do</span></div><div class="line">            cp submodule_hooks_android/<span class="variable">${hook}</span> <span class="variable">${module_dir}</span>/custom_hooks/</div><div class="line">        	<span class="built_in">sudo</span> chmod -R <span class="number">755</span> <span class="variable">${module_dir}</span>/custom_hooks</div><div class="line">            <span class="built_in">sudo</span> chmod +x <span class="variable">${module_dir}</span>/custom_hooks/<span class="variable">${hook}</span></div><div class="line">        <span class="keyword">done</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure></p>
<p>钩子装好后，试着为 framework 子模块推送一下代码，终端中会看到 <code>Bump Version for submodule framework</code> 的字眼，表示 framework 的 commit id 已被成功更新到主工程：</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="label">C02PGTP8FVH5:</span>PAFFHouse hahack$ git <span class="keyword">push</span> -u origin jilin_dev</div><div class="line">Counting objects: <span class="number">3</span>, done.</div><div class="line">Delta compression using up to <span class="number">4</span> threads.</div><div class="line">Compressing objects: <span class="number">100</span>% (<span class="number">2</span>/<span class="number">2</span>), done.</div><div class="line">Writing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), <span class="number">308</span> bytes | <span class="number">0</span> bytes/s, done.</div><div class="line">Total <span class="number">3</span> (delta <span class="number">1</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</div><div class="line"><span class="label">remote:</span></div><div class="line"><span class="label">remote:</span> ========================================================================        </div><div class="line"><span class="label">remote:</span> </div><div class="line"><span class="label">remote:</span>         faq: http://yourcampany.com/yourgroup/FFWiki/wikis/git-faq        </div><div class="line"><span class="label">remote:</span> </div><div class="line"><span class="label">remote:</span> ========================================================================        </div><div class="line"><span class="label">remote:</span> [jilin_dev <span class="number">941</span>f8c5] Bump Version for submodule framework:        </div><div class="line"><span class="label">remote:</span>  <span class="number">1</span> file changed, <span class="number">1</span> insertion(+), <span class="number">1</span> deletion(-)        </div><div class="line"><span class="label">remote:</span> Updating commit id        </div><div class="line"><span class="label">remote:</span> Bumping version of branch jilin_dev of main project...        </div><div class="line"><span class="label">remote:</span> Bumping version of branch jilin_dev of father project...        </div><div class="line"><span class="label">remote:</span> Successfully bumped version branch jilin_dev of father project        </div><div class="line"><span class="label">remote:</span> remote:</div><div class="line"><span class="label">remote:</span> remote: ========================================================================                </div><div class="line"><span class="label">remote:</span> remote:         </div><div class="line"><span class="label">remote:</span> remote:         faq: http://yourcampany.com/yourgroup/FFWiki/wikis/git-faq                </div><div class="line"><span class="label">remote:</span> remote:         </div><div class="line"><span class="label">remote:</span> remote: ========================================================================            </div><div class="line"><span class="label">remote:</span> To http://yourcampany.com/yourgroup/App_Android.git        </div><div class="line"><span class="label">remote:</span>    aa13394.<span class="number">.69e6</span>c467  HEAD -&gt; jilin_dev        </div><div class="line">To http://yourcampany.com/yourgroup/framework_android.git</div><div class="line">   e41b275.<span class="number">.35141</span>bf  jilin_dev -&gt; jilin_dev</div><div class="line">Branch jilin_dev <span class="keyword">set</span> up to track remote branch jilin_dev from origin.</div></pre></td></tr></table></figure></p>
<p>上面的步骤执行了两次 push 操作：</p>
<ol>
<li>push framework 子模块的代码；</li>
<li>push 主工程的代码，更新 framework 的 commit id 。这个 push 操作是由 framework 的 post-receive 钩子自动完成的。</li>
</ol>
<p>等候一段时间后，打开主工程的持续集成页面，可以找到这次子模块更新触发的提交以及持续集成的结果：</p>
<p><img src="/images/enterprise-class-git-version-control-2/framework-bump.png" alt="非嵌套子模块的持续集成结果"></p>
<p>对于嵌套子模块，父模块提交完子模块的 commit id ，同样会触发父模块的 post-receive 钩子，于是会看到这样的推送结果：</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">C02PGTP8FVH5:HFCommon hahack$ git push -u origin master_dev</div><div class="line">Counting objects: <span class="number">3</span>, done.</div><div class="line">Delta compression <span class="keyword">using</span> up <span class="built_in">to</span> <span class="number">4</span> threads.</div><div class="line">Compressing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), done.</div><div class="line">Writing objects: <span class="number">100</span>% (<span class="number">3</span>/<span class="number">3</span>), <span class="number">305</span> <span class="keyword">bytes</span> | <span class="number">0</span> <span class="keyword">bytes</span>/s, done.</div><div class="line">Total <span class="number">3</span> (delta <span class="number">2</span>), reused <span class="number">0</span> (delta <span class="number">0</span>)</div><div class="line">remote: </div><div class="line">remote: ========================================================================        </div><div class="line">remote: </div><div class="line">remote:         faq: <span class="keyword">http</span>://yourcampany.com/yourgroup/FFWiki/wikis/git-faq        </div><div class="line">remote: </div><div class="line">remote: ========================================================================        </div><div class="line">remote: warning: unable <span class="built_in">to</span> rmdir FinancialProduct: Directory <span class="operator">not</span> <span class="constant">empty</span>        </div><div class="line">remote: [taishan <span class="number">941</span>b017] Bump Version <span class="keyword">for</span> submodule HFCommon:        </div><div class="line">remote:  <span class="number">1</span> <span class="built_in">file</span> changed, <span class="number">1</span> insertion(+), <span class="number">1</span> deletion(-)</div><div class="line">remote: Updating commit id        </div><div class="line">remote: Bumping <span class="built_in">version</span> <span class="operator">of</span> branch taishan <span class="operator">of</span> main project...        </div><div class="line">remote: Bumping <span class="built_in">version</span> <span class="operator">of</span> branch taishan <span class="operator">of</span> father project...        </div><div class="line">remote: Successfully bumped <span class="built_in">version</span> branch taishan <span class="operator">of</span> father project        </div><div class="line">remote: Bumping <span class="built_in">version</span> <span class="operator">of</span> branch taishan_dev <span class="operator">of</span> main project...  </div><div class="line">remote: remote:         </div><div class="line">remote: remote: ========================================================================                </div><div class="line">remote: remote:         </div><div class="line">remote: remote:         faq: <span class="keyword">http</span>://yourcampany.com/yourgroup/FFWiki/wikis/git-faq                </div><div class="line">remote: remote:         </div><div class="line">remote: remote: ========================================================================                </div><div class="line">remote: remote: [taishan f43ab33] Bump Version <span class="keyword">for</span> submodule react_native:                </div><div class="line">remote: remote:  <span class="number">1</span> <span class="built_in">file</span> changed, <span class="number">1</span> insertion(+), <span class="number">1</span> deletion(-)                </div><div class="line">remote: remote: Updating commit id                </div><div class="line">remote: remote: Bumping <span class="built_in">version</span> <span class="operator">of</span> branch taishan <span class="operator">of</span> main project...                </div><div class="line">remote: remote: Bumping <span class="built_in">version</span> <span class="operator">of</span> branch taishan <span class="operator">of</span> father project...                </div><div class="line">remote: remote: Successfully bumped <span class="built_in">version</span> branch taishan <span class="operator">of</span> father project                </div><div class="line">remote: remote: remote:                 </div><div class="line">remote: remote: remote: ========================================================================                        </div><div class="line">remote: remote: remote:                 </div><div class="line">remote: remote: remote:         faq: <span class="keyword">http</span>://yourcampany.com/yourgroup/FFWiki/wikis/git-faq                        </div><div class="line">remote: remote: remote:                 </div><div class="line">remote: remote: remote: ========================================================================                        </div><div class="line">remote: remote: To <span class="keyword">http</span>://yourcampany.com/yourgroup/App_Android.git                </div><div class="line">remote: remote:    <span class="number">50</span>b73a2..f43ab33  HEAD -&gt; taishan                </div><div class="line">remote: To <span class="keyword">http</span>://yourcampany.com/yourgroup/react_native.git        </div><div class="line">remote:    <span class="number">3552248.</span><span class="number">.941</span>b017  HEAD -&gt; taishan        </div><div class="line">To <span class="keyword">http</span>://yourcampany.com/yourgroup/HFCommon.git</div><div class="line">   <span class="number">4940</span>def.<span class="number">.7</span>a59ff0  master_dev -&gt; master_dev</div><div class="line">Branch master_dev <span class="built_in">set</span> up <span class="built_in">to</span> track remote branch master_dev <span class="built_in">from</span> origin.</div></pre></td></tr></table></figure></p>
<p>在主工程的持续集成页面中同样可以找出嵌套子模块触发的提交和持续集成结果：</p>
<p><img src="/images/enterprise-class-git-version-control-2/embeb-bump.png" alt="嵌套子模块的持续集成结果"></p>
<p>只剩第三个问题未解决了。由于模块和分支不断在新增，上面的这两个文件肯定是需要经常更新，新增模块也需要安装这个钩子。这些既然已经可以用工具自动完成，只需要把工具都加进了 crontab 计划任务里，设定每天凌晨三点钟就自动执行一遍，问题完美解决！</p>
<p>使用这个方案后，所有的子模块发生更新，都会触发依赖该子模块的主工程的持续集成测试。当发现主工程突然不能编译了，可以打开 Gitlab ，迅速定位到最早导致编译不过的子模块及提交：</p>
<p><img src="/images/enterprise-class-git-version-control-2/problem-commit.png" alt="利用Gitlab定位编译问题"></p>
<p>这为我们定位编译问题提供了非常重要的线索！</p>
<h2 id="后话">后话</h2>
<p>在本篇文章中，我仔细讨论了对子模块进行持续集成的三种方案，并利用自动化手段实现逐层往上提交子模块 commit id 从而触发主工程构建。这些构建结果对我们快速定位工程编译不过的问题提供了重要的线索。</p>
<p>说下其他一些值得注意的地方。有些时候某个模块的代码推送无法避免会导致暂时性的编译失败（比如涉及多个模块的代码提交），又不想被误认为是导致后面编译不过的罪魁祸首，那就可以通过在这些中间提交任务的 commit message 中加上 <code>[ci skip]</code> 字段，告诉 Gitlab 跳过对这些提交的构建测试，只在最后一次提交中去除该字段，检查最后一次的提交即可。</p>
<p>另外一个问题是，自从启用了这种方案，我们服务器上的构建任务一下子爆增。一个子模块的代码推送可能会触发多个构建任务，而我们目前负责持续集成的机器还很少。这使得推送完代码后，往往需要等上半天才能看到结果，这可能会影响问题定位的及时性。我们在后面准备进行一个有趣的尝试：每个客户端开发者的机器其实已具备了构建至少一个平台的客户端的条件，所以可以利用开发机的剩余资源来帮忙构建。具体方法是：每个开发者将自己的机器注册为一个 Runner ，并自行打上 android 或者 ios 标签，标明机器能编译哪个平台的客户端：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gitlab-ci-multi-runner register -url http://yourcompany.com/ci -registration-token z_AvFaP<span class="built_in">cd</span>F9aE3sseEvw --name <span class="string">"android-panweizhou"</span>  --limit <span class="number">1</span> --executor shell --shell bash --tag-list <span class="string">"android"</span></div></pre></td></tr></table></figure></p>
<p>当机器暂时空余时，可以开启这个 Runner ，加入帮忙构建的队伍。Gitlab 将根据该 Runner 的标签为其安排相应平台的构建任务：</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gitlab-ci-multi-runner start</div></pre></td></tr></table></figure></p>
<p>年底我们将统计出 Gitlab 上这些 Runner 的构建次数，对次数多的 Runner 进行表彰。真是躺着就把钱挣了有木有！</p>

		</div>

		<!-- bdshare -->
		
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"5","bdPos":"left","bdTop":"100"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


        

		<!-- pagination -->
		<div>
		<center>
		<div class="pagination">
	 
      <ul>
		
		<li class="prev"><a data-pjax href="/work/enterprise-class-git-version-control-3/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

		<li><a data-pjax href="/archive"><i class="fa fa-archive"></i>Archive</a></li>

        
			<li class="next"><a data-pjax href="/work/enterprise-class-git-version-control-1/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>           
      </ul>
	
</div>

	        </center>
		</div>

        <!-- donate -->
        <!-- Donate Module -->
<div id="donate_module">
	<!-- css -->
	<style type="text/css">
		.donate_bar a.btn_donate{
			display: inline-block;
			width: 82px;
			height: 82px;
			background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			_background: url("http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif") no-repeat;
			<!-- 因为本 hexo 生成的博客所用的 theme 的 a:hover 带动画效果，
				 为了在让打赏按钮显示效果正常 而 添加了以下几行 css，
				 嵌入其它博客时不一定要它们。 -->
			-webkit-transition: background 0s;
			-moz-transition: background 0s;
			-o-transition: background 0s;
			-ms-transition: background 0s;
			transition: background 0s;
			<!-- /让打赏按钮的效果显示正常 而 添加的几行 css 到此结束 -->
		}
		.donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
		.donate_bar .donate_txt {
			display: block;
			color: #9d9d9d;
			font: 14px/2 "Microsoft Yahei";
		}
		.bold{ font-weight: bold; }
	</style>
	<!-- /css -->
	<!-- btn_donate & tips -->
	<div id="donate_board" class="donate_bar center">
		<a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
	</div>
	<!-- /btn_donate & tips -->
	<!-- donate guide -->
	<div id="donate_guide" class="donate_bar center hidden">
        <div class="row center">
		<a href="/images/misc/alipay.png" title="Alipay_Scan_Payment" class="fancybox">
			<img src="/images/misc/alipay.png" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>&nbsp;
		<a href="/images/misc/wechatpay.jpeg" title="WeChat_Scan_Payment" class="fancybox">
			<img src="/images/misc/wechatpay.jpeg" title="Donate 打赏" height="164px" width="164px" style="display:inherit;"/>
		</a>
        </div>
		<span class="donate_txt">
			Use App <span class="bold"><a href="http://global.alipay.com/ospay/home.htm">Alipay</a> / <a href="http://www.wechat.com/en/">WeChat</a></span>
			to scan QRCode~ Thx for your support.<br/>
			用手机 <span class="bold"><a href="https://mobile.alipay.com/index.htm">支付宝钱包</a> / <a href="http://weixin.qq.com/">微信</a></span>，
			扫一扫即可~ 谢谢您的鼓励。<br/>
			<br/>
		</span>
		<br/>
	</div>
	<!-- /donate guide -->
	<!-- donate script -->
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
	<!-- /donate script -->
</div>
<!-- /Donate Module -->


		<!-- toc -->
		
   	<script type="text/javascript">
		jQuery(document).ready(function() {
				
		   generatePostTOC('.mypage',  2 , 2 );
		
		});
	</script>




		<!-- comment -->
		
<section id="comment">
    <h2 class="title">Comments</h2>
	
	 <div id="comment-thread"></div>
	 <div id="loading-spin"></div>
	 <script type="text/javascript">
	   getComments({
		       type: "github",
	           user: "wzpan",
	           repo: "wzpan.github.io",
			   client_id: "1eb35434de75c06a513f",
			   client_secret: "6e4193f8ecd619cdfac2b1aa16b3663fe18d2e90",
			   no_comment: "暂时还没有留言呢，点击下面的按钮去留言吧！",
			   go_to_comment: "去留言",
			   btn_class: "btn btn-primary",
			   no_issue: "no_issue",
			   issue_title: "化繁为简的企业级 Git 管理实战（二）：多分支子模块持续集成",
			   issue_id: "undefined",
			   comments_target: "#comment-thread" ? "#comment-thread" : "#comment-thread",
			   loading_target: "undefined"
			   });
	 </script>
	
</section>



		
	</div> <!-- span9/span12 -->
	
		<div class="span3">

	<!-- donate -->
	<div class="meta-widget">
	<a href="#donate_module" id="a_donate" class="a_donate"><i class="fa fa-smile-o"></i> Donate this article</a>
	</div>

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	Apr 21 2016 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a data-pjax href="/categories/work/">work<span>7</span></a></li>
  </li>

    </ul>
	</div>
	
	
  	<!-- tags -->
	
	<div class="meta-widget">
	<a data-pjax data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a data-pjax href="/tags/Git/">Git<span>5</span></a></li> <li><a data-pjax href="/tags/CI/">CI<span>1</span></a></li>

    </ul>
	</div>
		
	
    <hr>
</div><!-- span3 -->

<!-- donate script -->
	<script type="text/javascript">
		document.getElementById('a_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
	

</div><!-- row-fluid post-full -->

	</div>	
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 Joseph Pan
  
    <small>
     <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh"><img title="知识共享许可协议" style="border-width: 0px; vertical-align: middle; display: inline; " src="/images/license.png"></a>
    </small>
</p>
 </footer>
</div> <!-- container-narrow -->


<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/dist/jquery.imagesloaded.min.js"></script>


<script src="/dist/gallery.min.js"></script>
<script src="/dist/bootstrap.min.js"></script>
<script src="/dist/jquery.tableofcontents.min.js"></script>
<script src="/dist/tocgenerator.min.js"></script>
<script src="/dist/require.min.js"></script>
<script src="/dist/main.min.js"></script>



<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox({
    helpers : { 
        title : { type : 'inside' }
    },
    afterLoad : function() {
        this.title = (this.title ? '' + this.title + '<br />' : '') + 'Image ' + (this.index + 1) + ' of ' + this.group.length;
    }
  });
})(jQuery);
</script>




<!-- syntax highlighting -->

  <script>
  marked.setOptions({
    highlight: function (code, lang) {
        return hljs.highlightAuto(code).value;
    }
  });
  function Highlighting(){
    var markdowns = document.getElementsByClassName('markdown');
    for(var i=0;i<markdowns.length;i++){
        if(markdowns[i].innerHTML) markdowns[i].innerHTML =marked(markdowns[i].innerHTML);
    }
  }
  window.addEventListener('DOMContentLoaded', Highlighting, false);
  window.addEventListener('load', Highlighting, false);
  </script>



<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

  _st('install','ney3Rb77vMaWT2KUKFyt');
</script>





</body>
</html>
